# V1.8 Smart Context Loading - Deployment Checklist

**Deployed:** 2025-10-11
**Commit:** d71d8032
**Status:** ‚úÖ Code Deployed, ‚è≥ Configuration Pending

---

## ‚úÖ Completed

- [x] **Code Implementation** - All 4 core services created
- [x] **Agent Updates** - Solar Controller, Energy Orchestrator, Research Agent
- [x] **API Enhancements** - Request/response models updated
- [x] **Frontend Updates** - Chat UI displays context metadata
- [x] **Testing** - All unit tests passing
- [x] **Documentation** - Complete guides written
- [x] **Git Commit** - Pushed to main branch
- [x] **Railway Deploy** - Auto-deployment triggered

---

## ‚è≥ Configuration Required

### 1. Add Redis Service (CRITICAL)

**In Railway Dashboard:**
1. Go to: https://railway.app/dashboard
2. Select "CommandCenterProject"
3. Click "+ New" ‚Üí "Database" ‚Üí "Add Redis"
4. Railway will automatically set `REDIS_URL` environment variable
5. Wait ~2 minutes for Redis to provision

**Expected Result:**
- Redis service appears in project
- Backend service restarts automatically
- Logs show: `‚úÖ Redis connected: redis://...`

**Without Redis:**
- System works but no caching (degraded mode)
- Logs show: `‚ö†Ô∏è Redis connection failed. Caching disabled.`

---

### 2. Set Environment Variables (OPTIONAL)

**In Railway Dashboard:**
1. Select backend service
2. Go to "Variables" tab
3. Add (only if you want to override defaults):

```bash
# Cache settings
CONTEXT_CACHE_ENABLED=true          # Default: true
CONTEXT_CACHE_TTL=300               # Default: 300 (5 minutes)

# Token budgets (adjust based on usage)
CONTEXT_SYSTEM_TOKENS=2000          # Default: 2000
CONTEXT_RESEARCH_TOKENS=4000        # Default: 4000
CONTEXT_PLANNING_TOKENS=3500        # Default: 3500
CONTEXT_GENERAL_TOKENS=1000         # Default: 1000

# KB search limits
KB_MIN_SIMILARITY=0.3               # Default: 0.3
KB_MAX_DOCS_RESEARCH=5              # Default: 5
```

**Note:** Defaults are already configured in code. Only set these if you want different values.

---

## üß™ Testing

### Test 1: Basic Functionality (No Redis)

```bash
curl -X POST https://api.wildfireranch.us/ask \
  -H 'Content-Type: application/json' \
  -d '{
    "message": "What is my battery level?",
    "user_id": "test_user"
  }'
```

**Expected Response:**
```json
{
  "response": "Your battery is at 67%...",
  "query": "What is my battery level?",
  "agent_role": "Energy Systems Monitor",
  "duration_ms": 3250,
  "session_id": "abc-123...",
  "context_tokens": 2400,        ‚Üê Should be 2k-4k (down from 5k-8k)
  "cache_hit": false,            ‚Üê Will be false without Redis
  "query_type": "system"         ‚Üê Should classify correctly
}
```

‚úÖ **Success Criteria:**
- Response received
- `context_tokens` is 2k-4k (not 5k-8k)
- `query_type` is "system"
- Response quality is good

---

### Test 2: Cache Functionality (With Redis)

**After adding Redis, run same query twice:**

```bash
# First request (cache miss)
curl -X POST https://api.wildfireranch.us/ask \
  -H 'Content-Type: application/json' \
  -d '{"message": "What is my battery level?", "user_id": "test_user"}'

# Second request (cache hit)
curl -X POST https://api.wildfireranch.us/ask \
  -H 'Content-Type: application/json' \
  -d '{"message": "What is my battery level?", "user_id": "test_user"}'
```

**Expected:**
- 1st request: `"cache_hit": false`, duration ~3-4 seconds
- 2nd request: `"cache_hit": true`, duration ~2-3 seconds (faster!)

‚úÖ **Success Criteria:**
- Cache hit rate >60% after 10 queries
- Cached requests are faster

---

### Test 3: Query Classification

Test different query types:

```bash
# SYSTEM query
curl -X POST https://api.wildfireranch.us/ask \
  -d '{"message": "What is my battery level?", "user_id": "test"}'

# RESEARCH query
curl -X POST https://api.wildfireranch.us/ask \
  -d '{"message": "What are best practices for solar?", "user_id": "test"}'

# PLANNING query
curl -X POST https://api.wildfireranch.us/ask \
  -d '{"message": "Plan next week energy usage", "user_id": "test"}'

# GENERAL query
curl -X POST https://api.wildfireranch.us/ask \
  -d '{"message": "Hello!", "user_id": "test"}'
```

**Expected:**
- SYSTEM: `context_tokens` ~2000, `query_type: "system"`
- RESEARCH: `context_tokens` ~4000, `query_type: "research"`
- PLANNING: `context_tokens` ~3500, `query_type: "planning"`
- GENERAL: `context_tokens` ~1000, `query_type: "general"`

‚úÖ **Success Criteria:**
- Each query type classified correctly
- Token counts match expected ranges

---

### Test 4: Frontend Integration

1. Navigate to: http://localhost:3000/chat
2. Ask: "What's my battery level?"
3. Look for metadata badges on response:
   - Blue badge: Query type (e.g., "system")
   - Green badge: Token count (e.g., "2,400 tokens")
   - Purple/Gray badge: Cache status ("‚ö° cached" or "fresh")

‚úÖ **Success Criteria:**
- All badges display correctly
- Token count is lower than before
- Cache status updates on repeat queries

---

## üìä Monitoring (First 24 Hours)

### Key Metrics to Track

Monitor in Railway logs (View Logs ‚Üí Filter by "context"):

#### 1. Token Usage
```
INFO - Smart context loaded: 2400 tokens, type=system, cache_hit=False
```
**Target:** Average 2k-4k (down from 5k-8k)

#### 2. Classification Accuracy
```
INFO - Query classified as system (confidence: 95%)
```
**Target:** >90% confidence for most queries

#### 3. Cache Performance
```
INFO - Cache hit for query type system
```
**Target:** >60% hit rate after initial queries

#### 4. Error Rate
```
‚ö†Ô∏è Redis connection failed: ... Caching disabled.
```
**Action:** Add Redis service if you see this

---

## üêõ Troubleshooting

### Issue: Redis Connection Failed

**Symptom:**
```
‚ö†Ô∏è Redis connection failed: Connection refused. Caching disabled.
```

**Solution:**
1. Add Redis service in Railway (see step 1 above)
2. Verify `REDIS_URL` environment variable is set
3. Restart backend service
4. Check logs for: `‚úÖ Redis connected`

**Note:** System still works without Redis, just no caching.

---

### Issue: Token Usage Not Reduced

**Symptom:** `context_tokens` still 5k-8k

**Solution:**
1. Check query classification in logs
2. Verify token budgets in environment variables
3. Check KB search is filtering correctly
4. Review V1.8_IMPLEMENTATION_COMPLETE.md troubleshooting section

---

### Issue: Cache Not Working

**Symptom:** `cache_hit` always `false`

**Solution:**
1. Verify Redis is connected (check logs)
2. Ensure `CONTEXT_CACHE_ENABLED=true` (default)
3. Use same `user_id` for repeat queries
4. Wait <5 minutes between requests (TTL)

---

## üìà Success Metrics

After 24 hours, you should see:

| Metric | Target | How to Check |
|--------|--------|--------------|
| Average tokens/query | 2k-4k | Check `context_tokens` in responses |
| Token reduction | 40-60% | Compare to old logs (5k-8k) |
| Cache hit rate | >60% | Count `cache_hit: true` in logs |
| Classification accuracy | >90% | Check `confidence` in logs |
| Error rate | <1% | Count errors in logs |
| Response time (cached) | <3s | Check `duration_ms` for cache hits |

---

## üéØ Next Steps

1. **Immediate (Today):**
   - [ ] Add Redis service in Railway
   - [ ] Run Test 1 (basic functionality)
   - [ ] Run Test 2 (cache with Redis)
   - [ ] Test frontend at /chat

2. **Within 24 Hours:**
   - [ ] Monitor token usage in logs
   - [ ] Track cache hit rate
   - [ ] Verify cost savings
   - [ ] Report any issues

3. **Within 1 Week:**
   - [ ] Fine-tune token budgets if needed
   - [ ] Optimize cache TTL based on usage
   - [ ] Review classification accuracy
   - [ ] Document any learnings

---

## üìû Support

**Documentation:**
- Full guide: [V1.8_IMPLEMENTATION_COMPLETE.md](V1.8_IMPLEMENTATION_COMPLETE.md)
- Environment vars: [railway/.env.example](railway/.env.example)
- Architecture: [PROMPT_V2.0_SMART_CONTEXT.md](PROMPT_V2.0_SMART_CONTEXT.md)

**Railway Dashboard:**
- Project: https://railway.app/dashboard
- Backend service: View Logs for debugging
- Redis service: Check connection status

**Expected Behavior:**
- Token usage drops 40-60% ‚úÖ
- Cache hits >60% for repeated queries ‚úÖ
- Response times faster with cache ‚úÖ
- System works without Redis (degraded mode) ‚úÖ

---

**Status:** Ready for configuration and testing! üöÄ
