# V1.6 Frontend: Add Victron Battery Dashboard

**Version:** V1.5 → V1.6
**Target:** Streamlit Dashboard (`dashboards/pages/2_⚡_Energy_Monitor.py`)
**Estimated Time:** 3-4 hours
**Priority:** Medium - Enhanced visualization for V1.6 Victron data

---

## 🎯 Objective

Add **Victron Cerbo GX battery data** to the Energy Monitor dashboard with real-time metrics, historical charts, and comparison views between SolArk and Victron battery readings.

**Why This Matters:**
- Victron provides more accurate battery data (direct shunt connection)
- Users need to see voltage, current, temperature trends over time
- Compare Victron vs SolArk readings to validate accuracy
- Foundation for V2 battery health monitoring

---

## 📚 Background Context

### Current State (V1.5)
- **Dashboard:** `dashboards/pages/2_⚡_Energy_Monitor.py`
- **Data Source:** SolArk API only (battery SOC, power)
- **Metrics:** Basic SOC and power flow
- **Visualization:** Simple Plotly charts

### Target State (V1.6)
- **New Data Source:** Victron VRM API (via Railway backend)
- **New Metrics:** SOC, voltage, current, power, temperature, state
- **New Section:** "Battery Details" with Victron data
- **New Charts:**
  - Battery voltage over time
  - Current (charge/discharge) over time
  - Temperature trends
  - SOC comparison (Victron vs SolArk)

---

## 🔌 Available API Endpoints

### Backend Endpoints (Already Implemented)

#### 1. **GET /victron/battery/current**
Latest battery reading from Victron Cerbo GX.

**Response:**
```json
{
  "status": "success",
  "data": {
    "timestamp": "2025-10-12T22:48:19Z",
    "installation_id": "290928",
    "soc": 99.3,
    "voltage": 54.09,
    "current": -1.1,
    "power": -59.5,
    "state": "discharging",
    "temperature": 25.9
  },
  "timestamp": 1697145299.123
}
```

#### 2. **GET /victron/battery/history**
Historical battery readings (up to 72 hours).

**Query Parameters:**
- `hours` - Hours to look back (default: 24, max: 72)
- `limit` - Max records (default: 100, max: 1000)

**Response:**
```json
{
  "status": "success",
  "count": 480,
  "hours": 24,
  "data": [
    {
      "timestamp": "2025-10-12T22:48:00Z",
      "soc": 99.3,
      "voltage": 54.09,
      "current": -1.1,
      "power": -59.5,
      "state": "discharging",
      "temperature": 25.9
    },
    // ... more readings
  ]
}
```

#### 3. **GET /victron/health**
Victron integration health status.

**Response:**
```json
{
  "status": "success",
  "data": {
    "poller_running": true,
    "last_poll_attempt": "2025-10-12T22:48:00Z",
    "last_successful_poll": "2025-10-12T22:48:00Z",
    "consecutive_failures": 0,
    "is_healthy": true,
    "readings_count_24h": 480,
    "api_requests_this_hour": 18,
    "rate_limit_max": 50
  }
}
```

---

## 🎨 Design Requirements

### Layout

Update `2_⚡_Energy_Monitor.py` with new sections:

```
┌─────────────────────────────────────────────────────────────┐
│  ⚡ Energy Monitoring Dashboard                             │
│  Solar production, battery status, and power flow           │
├─────────────────────────────────────────────────────────────┤
│  [Auto-refresh: 30s ▼]                    [Last: 14:30:15]  │
├─────────────────────────────────────────────────────────────┤
│  REAL-TIME METRICS (Existing)                               │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                       │
│  │ SOC  │ │Solar │ │ Load │ │ Grid │                       │
│  └──────┘ └──────┘ └──────┘ └──────┘                       │
├─────────────────────────────────────────────────────────────┤
│  🔋 BATTERY DETAILS (NEW - Victron Cerbo)                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ Voltage  │ │ Current  │ │  Power   │ │   Temp   │      │
│  │ 54.09V   │ │ -1.1A    │ │ -59.5W   │ │ 25.9°C   │      │
│  │ Normal   │ │Discharg. │ │ Light    │ │ Optimal  │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│                                                              │
│  Data Source: Victron Cerbo GX (via ShackTemp sensor)      │
│  Last Updated: 2 seconds ago • Status: ✅ Healthy          │
├─────────────────────────────────────────────────────────────┤
│  📊 BATTERY TRENDS (24 HOURS) (NEW)                         │
│                                                              │
│  ┌─────────────────────────────────────────┐                │
│  │ Battery Voltage (V)                     │                │
│  │ ──────────────────────────────────      │                │
│  │   54.2V ━━━━━━━━━━━━━━━━━━━━━━━━━━     │                │
│  │   52.8V                                  │                │
│  └─────────────────────────────────────────┘                │
│                                                              │
│  ┌─────────────────────────────────────────┐                │
│  │ Current (A) - Charge/Discharge          │                │
│  │  +15A ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │                │
│  │    0A ────────────────────────────────   │                │
│  │  -15A ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │                │
│  └─────────────────────────────────────────┘                │
│                                                              │
│  ┌─────────────────────────────────────────┐                │
│  │ Temperature (°C)                         │                │
│  │   28°C ━━━━━━━━━━━━━━━━━━━━━━━━━━━     │                │
│  │   22°C                                   │                │
│  └─────────────────────────────────────────┘                │
├─────────────────────────────────────────────────────────────┤
│  🔍 DATA COMPARISON (NEW)                                   │
│                                                              │
│  ┌─────────────────────────────────────────┐                │
│  │ SOC: Victron vs SolArk                  │                │
│  │                                          │                │
│  │  100% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │                │
│  │   90% ─ Victron (accurate)              │                │
│  │   80% ─ SolArk (estimated)              │                │
│  │   70%                                    │                │
│  └─────────────────────────────────────────┘                │
│                                                              │
│  Difference: 0.5% • Status: ✅ Readings aligned            │
├─────────────────────────────────────────────────────────────┤
│  📈 HISTORICAL DATA (Existing, keep as-is)                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 📋 Implementation Checklist

### Step 1: Add API Client Methods (2 hours)

**File:** `dashboards/components/api_client.py`

Add methods to fetch Victron data:

```python
def get_victron_battery_current(self):
    """Get latest Victron battery reading."""
    response = requests.get(
        f"{self.base_url}/victron/battery/current",
        headers=self.headers,
        timeout=10
    )
    response.raise_for_status()
    return response.json()

def get_victron_battery_history(self, hours=24, limit=480):
    """Get Victron battery history."""
    response = requests.get(
        f"{self.base_url}/victron/battery/history",
        params={"hours": hours, "limit": limit},
        headers=self.headers,
        timeout=10
    )
    response.raise_for_status()
    return response.json()

def get_victron_health(self):
    """Get Victron integration health."""
    response = requests.get(
        f"{self.base_url}/victron/health",
        headers=self.headers,
        timeout=10
    )
    response.raise_for_status()
    return response.json()
```

**Acceptance Criteria:**
- ✅ Methods successfully call Victron endpoints
- ✅ Error handling for API failures
- ✅ Timeout handling (10 seconds)

---

### Step 2: Add Battery Details Section (1 hour)

**File:** `dashboards/pages/2_⚡_Energy_Monitor.py`

After the existing real-time metrics, add:

```python
# ─────────────────────────────────────────────────────────────────
# BATTERY DETAILS (Victron Cerbo)
# ─────────────────────────────────────────────────────────────────

st.markdown("---")
st.subheader("🔋 Battery Details (Victron Cerbo GX)")

try:
    # Fetch Victron data
    victron_response = api.get_victron_battery_current()

    if victron_response["status"] == "success":
        victron_data = victron_response["data"]

        # Display 4-column metrics
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            voltage = victron_data.get("voltage")
            st.metric(
                label="Battery Voltage",
                value=f"{voltage:.2f}V" if voltage else "N/A",
                delta="Normal" if 52 <= voltage <= 58 else "⚠️ Check",
                delta_color="normal" if 52 <= voltage <= 58 else "off"
            )

        with col2:
            current = victron_data.get("current")
            state = victron_data.get("state", "unknown")
            st.metric(
                label="Current",
                value=f"{current:.1f}A" if current else "N/A",
                delta=state.capitalize(),
                delta_color="normal" if state == "charging" else "inverse" if state == "discharging" else "off"
            )

        with col3:
            power = victron_data.get("power")
            st.metric(
                label="Power",
                value=f"{abs(power):.0f}W" if power else "N/A",
                delta="Charging" if power > 0 else "Discharging" if power < 0 else "Idle",
                delta_color="normal" if power > 0 else "inverse" if power < 0 else "off"
            )

        with col4:
            temp = victron_data.get("temperature")
            if temp:
                temp_f = (temp * 9/5) + 32
                st.metric(
                    label="Temperature",
                    value=f"{temp:.1f}°C",
                    delta=f"{temp_f:.1f}°F",
                    delta_color="normal" if 15 <= temp <= 30 else "off"
                )
            else:
                st.metric(label="Temperature", value="N/A")

        # Status line
        timestamp = victron_data.get("timestamp")
        if timestamp:
            from datetime import datetime
            dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
            age = (datetime.now(dt.tzinfo) - dt).total_seconds()
            age_str = f"{int(age)} seconds ago" if age < 60 else f"{int(age/60)} minutes ago"
        else:
            age_str = "unknown"

        # Check health
        health = api.get_victron_health()
        is_healthy = health.get("data", {}).get("is_healthy", False)

        st.caption(
            f"📡 Data Source: **Victron Cerbo GX** (via ShackTemp sensor) | "
            f"Last Updated: **{age_str}** | "
            f"Status: **{'✅ Healthy' if is_healthy else '⚠️ Check Connection'}**"
        )
    else:
        st.warning("⚠️ No Victron battery data available")

except Exception as e:
    st.error(f"❌ Error loading Victron data: {str(e)}")
```

**Acceptance Criteria:**
- ✅ 4 metric cards display correctly
- ✅ Delta colors indicate charge/discharge state
- ✅ Temperature converts to Fahrenheit
- ✅ Status line shows data age and health
- ✅ Error handling for API failures

---

### Step 3: Add Battery Trend Charts (1.5 hours)

Add after Battery Details section:

```python
# ─────────────────────────────────────────────────────────────────
# BATTERY TRENDS (24 HOURS)
# ─────────────────────────────────────────────────────────────────

st.markdown("---")
st.subheader("📊 Battery Trends (24 Hours)")

# Time range selector
col1, col2 = st.columns([2, 1])
with col1:
    hours = st.selectbox(
        "Time Range",
        options=[6, 12, 24, 48, 72],
        index=2,  # Default to 24 hours
        format_func=lambda x: f"Last {x} hours"
    )

try:
    # Fetch historical data
    history_response = api.get_victron_battery_history(hours=hours, limit=1000)

    if history_response["status"] == "success" and history_response["count"] > 0:
        import pandas as pd

        # Convert to DataFrame
        df = pd.DataFrame(history_response["data"])
        df["timestamp"] = pd.to_datetime(df["timestamp"])
        df = df.sort_values("timestamp")

        # ─────────────────────────────────────────────────────────
        # Chart 1: Battery Voltage
        # ─────────────────────────────────────────────────────────

        fig_voltage = go.Figure()
        fig_voltage.add_trace(go.Scatter(
            x=df["timestamp"],
            y=df["voltage"],
            mode="lines",
            name="Voltage",
            line=dict(color="#3b82f6", width=2),
            fill="tozeroy",
            fillcolor="rgba(59, 130, 246, 0.1)"
        ))

        # Add safe voltage range (52-58V for 48V system)
        fig_voltage.add_hrect(
            y0=52, y1=58,
            fillcolor="rgba(34, 197, 94, 0.1)",
            line_width=0,
            annotation_text="Safe Range",
            annotation_position="top left"
        )

        fig_voltage.update_layout(
            title="Battery Voltage Over Time",
            xaxis_title="Time",
            yaxis_title="Voltage (V)",
            height=300,
            margin=dict(l=0, r=0, t=40, b=0),
            hovermode="x unified"
        )

        st.plotly_chart(fig_voltage, use_container_width=True)

        # ─────────────────────────────────────────────────────────
        # Chart 2: Current (Charge/Discharge)
        # ─────────────────────────────────────────────────────────

        fig_current = go.Figure()

        # Separate charging and discharging for different colors
        df_charging = df[df["current"] > 0]
        df_discharging = df[df["current"] < 0]

        fig_current.add_trace(go.Scatter(
            x=df_charging["timestamp"],
            y=df_charging["current"],
            mode="lines",
            name="Charging",
            line=dict(color="#22c55e", width=2),
            fill="tozeroy",
            fillcolor="rgba(34, 197, 94, 0.2)"
        ))

        fig_current.add_trace(go.Scatter(
            x=df_discharging["timestamp"],
            y=df_discharging["current"],
            mode="lines",
            name="Discharging",
            line=dict(color="#ef4444", width=2),
            fill="tozeroy",
            fillcolor="rgba(239, 68, 68, 0.2)"
        ))

        # Add zero line
        fig_current.add_hline(
            y=0,
            line_dash="dash",
            line_color="gray",
            annotation_text="Idle"
        )

        fig_current.update_layout(
            title="Battery Current (Charge/Discharge)",
            xaxis_title="Time",
            yaxis_title="Current (A)",
            height=300,
            margin=dict(l=0, r=0, t=40, b=0),
            hovermode="x unified"
        )

        st.plotly_chart(fig_current, use_container_width=True)

        # ─────────────────────────────────────────────────────────
        # Chart 3: Temperature Trend
        # ─────────────────────────────────────────────────────────

        if df["temperature"].notna().any():
            fig_temp = go.Figure()
            fig_temp.add_trace(go.Scatter(
                x=df["timestamp"],
                y=df["temperature"],
                mode="lines",
                name="Temperature",
                line=dict(color="#f59e0b", width=2),
                fill="tozeroy",
                fillcolor="rgba(245, 158, 11, 0.1)"
            ))

            # Add optimal temp range (15-30°C)
            fig_temp.add_hrect(
                y0=15, y1=30,
                fillcolor="rgba(34, 197, 94, 0.1)",
                line_width=0,
                annotation_text="Optimal Range",
                annotation_position="top left"
            )

            fig_temp.update_layout(
                title="Battery Temperature",
                xaxis_title="Time",
                yaxis_title="Temperature (°C)",
                height=300,
                margin=dict(l=0, r=0, t=40, b=0),
                hovermode="x unified"
            )

            st.plotly_chart(fig_temp, use_container_width=True)

        # ─────────────────────────────────────────────────────────
        # Statistics Summary
        # ─────────────────────────────────────────────────────────

        st.markdown("#### 📈 Summary Statistics")

        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric(
                "Avg Voltage",
                f"{df['voltage'].mean():.2f}V",
                delta=f"{df['voltage'].std():.2f}V std"
            )

        with col2:
            st.metric(
                "Avg Current",
                f"{df['current'].mean():.1f}A",
                delta=f"±{df['current'].std():.1f}A"
            )

        with col3:
            charging_time = (df['current'] > 0).sum() / len(df) * 100
            st.metric(
                "Charging Time",
                f"{charging_time:.0f}%",
                delta=f"{len(df[df['current'] > 0])} readings"
            )

        with col4:
            if df["temperature"].notna().any():
                st.metric(
                    "Avg Temp",
                    f"{df['temperature'].mean():.1f}°C",
                    delta=f"{df['temperature'].min():.1f}°C - {df['temperature'].max():.1f}°C"
                )

    else:
        st.info("📊 No historical data available for the selected time range")

except Exception as e:
    st.error(f"❌ Error loading historical data: {str(e)}")
```

**Acceptance Criteria:**
- ✅ Three charts display correctly (voltage, current, temperature)
- ✅ Charts show safe/optimal ranges highlighted
- ✅ Charging/discharging colored differently
- ✅ Time range selector works (6h, 12h, 24h, 48h, 72h)
- ✅ Summary statistics display correctly
- ✅ Error handling for missing data

---

### Step 4: Add SOC Comparison Chart (30 min)

Add after trend charts:

```python
# ─────────────────────────────────────────────────────────────────
# SOC COMPARISON: Victron vs SolArk
# ─────────────────────────────────────────────────────────────────

st.markdown("---")
st.subheader("🔍 Data Comparison: Victron vs SolArk")

try:
    # Get both data sources
    victron_soc = victron_data.get("soc") if 'victron_data' in locals() else None

    # Get SolArk data (existing code should have this)
    solark_response = api.get_latest_energy()
    solark_soc = solark_response.get("data", {}).get("soc")

    if victron_soc and solark_soc:
        col1, col2 = st.columns([3, 1])

        with col1:
            # Comparison bar chart
            fig_compare = go.Figure()

            fig_compare.add_trace(go.Bar(
                name="Victron (Accurate)",
                x=["SOC"],
                y=[victron_soc],
                marker_color="#3b82f6",
                text=[f"{victron_soc:.1f}%"],
                textposition="outside"
            ))

            fig_compare.add_trace(go.Bar(
                name="SolArk (Estimated)",
                x=["SOC"],
                y=[solark_soc],
                marker_color="#94a3b8",
                text=[f"{solark_soc:.1f}%"],
                textposition="outside"
            ))

            fig_compare.update_layout(
                title="State of Charge Comparison",
                yaxis_title="SOC (%)",
                yaxis_range=[0, 105],
                height=250,
                margin=dict(l=0, r=0, t=40, b=0),
                barmode="group"
            )

            st.plotly_chart(fig_compare, use_container_width=True)

        with col2:
            # Show difference
            diff = abs(victron_soc - solark_soc)
            st.metric(
                "Difference",
                f"{diff:.1f}%",
                delta="Readings aligned" if diff < 2 else "Check calibration",
                delta_color="normal" if diff < 2 else "off"
            )

            st.caption(
                f"**Victron:** Direct shunt reading (most accurate)  \n"
                f"**SolArk:** Inverter estimate  \n"
                f"**Status:** {'✅ Good alignment' if diff < 2 else '⚠️ Significant difference'}"
            )

    else:
        st.info("📊 Waiting for both Victron and SolArk data to compare")

except Exception as e:
    st.error(f"❌ Error comparing data: {str(e)}")
```

**Acceptance Criteria:**
- ✅ Shows side-by-side bars comparing SOC
- ✅ Calculates and displays difference
- ✅ Color-codes alignment status
- ✅ Explains which source is more accurate

---

## 🧪 Testing Checklist

### Manual Testing

1. **Load Dashboard**
   ```bash
   cd /workspaces/CommandCenter/dashboards
   streamlit run Home.py
   # Navigate to ⚡ Energy Monitor page
   ```

2. **Verify Real-Time Metrics**
   - ✅ Battery voltage displays correctly
   - ✅ Current shows positive/negative correctly
   - ✅ Temperature shows in both °C and °F
   - ✅ State (charging/discharging/idle) is accurate

3. **Verify Charts**
   - ✅ Voltage chart shows 24h trend
   - ✅ Current chart separates charging (green) and discharging (red)
   - ✅ Temperature chart shows with optimal range highlighted
   - ✅ Time range selector works (6h, 12h, 24h, etc.)

4. **Verify Comparison**
   - ✅ SOC comparison shows both Victron and SolArk
   - ✅ Difference is calculated correctly
   - ✅ Status indicator shows alignment

5. **Verify Health Status**
   - ✅ "Last Updated" shows correct age
   - ✅ Health status icon (✅/⚠️) displays correctly
   - ✅ Error messages display if API is down

6. **Verify Auto-Refresh**
   - ✅ Data updates automatically every 30 seconds
   - ✅ Charts refresh without flickering
   - ✅ No memory leaks after multiple refreshes

---

## 🎨 Design Guidelines

### Colors
- **Charging (positive current):** `#22c55e` (green)
- **Discharging (negative current):** `#ef4444` (red)
- **Voltage:** `#3b82f6` (blue)
- **Temperature:** `#f59e0b` (orange)
- **Victron data:** `#3b82f6` (blue)
- **SolArk data:** `#94a3b8` (gray)

### Typography
- **Section headers:** `st.subheader()` with emoji
- **Metric labels:** Clear, concise (e.g., "Battery Voltage")
- **Metric values:** Large, bold numbers
- **Delta text:** Action-oriented (e.g., "Charging", "Discharging")

### Spacing
- Use `st.markdown("---")` between major sections
- Maintain compressed vertical spacing (existing CSS)
- Use `st.caption()` for metadata (timestamps, sources)

---

## 📊 Data Refresh Strategy

### Real-Time Updates
- **Polling Interval:** Every 30 seconds (match existing)
- **Method:** Use existing `st.experimental_rerun()` pattern
- **Optimization:** Cache API calls for 30 seconds to reduce load

### Historical Data
- **Default Range:** 24 hours
- **Max Range:** 72 hours (limited by backend retention)
- **Update Frequency:** Only when user changes time range

---

## 🚨 Error Handling

### API Failures
```python
try:
    victron_data = api.get_victron_battery_current()
except requests.exceptions.Timeout:
    st.error("⏱️ Victron API timeout - check connection")
except requests.exceptions.ConnectionError:
    st.error("🔌 Cannot connect to backend API")
except Exception as e:
    st.error(f"❌ Unexpected error: {str(e)}")
    st.info("💡 Try refreshing the page or contact support")
```

### Missing Data
- **No readings:** Show "N/A" in metrics
- **No historical data:** Show info message with guidance
- **Partial data:** Display what's available, note missing fields

---

## ✅ Definition of Done

**This task is complete when:**

- ✅ Battery Details section displays 4 Victron metrics
- ✅ Three trend charts show voltage, current, temperature
- ✅ SOC comparison chart works correctly
- ✅ Time range selector allows 6h, 12h, 24h, 48h, 72h views
- ✅ Health status indicator shows poller status
- ✅ Data age ("X seconds ago") displays correctly
- ✅ Error handling gracefully handles API failures
- ✅ Auto-refresh works without issues
- ✅ All charts use consistent colors and styling
- ✅ Dashboard loads in < 2 seconds with cached data
- ✅ No console errors or warnings
- ✅ Mobile responsive (existing CSS maintained)

---

## 🔗 Related Files

### To Modify:
- `dashboards/pages/2_⚡_Energy_Monitor.py` - Main dashboard page
- `dashboards/components/api_client.py` - Add Victron API methods

### Reference:
- Backend API: `railway/src/api/main.py` (Victron endpoints)
- Backend Integration: `railway/src/integrations/victron.py`
- Existing energy charts for styling reference

---

## 📸 Expected Result

After implementation, users should see:

1. **Real-time battery metrics** from Victron with accurate shunt readings
2. **Beautiful trend charts** showing voltage, current, and temperature over time
3. **Comparison view** validating Victron vs SolArk accuracy
4. **Health indicators** showing integration status
5. **Responsive design** that works on desktop and mobile

**Visual Goal:** Professional, data-rich dashboard that provides actionable battery insights at a glance.

---

**Ready to implement!** 🚀

Copy this prompt to your AI assistant and begin with Step 1 (API Client Methods).
