# CommandCenter V1.5 Master Reference

**Version:** 1.5.0
**Last Updated:** December 10, 2025
**Status:** Production
**Purpose:** Quick reference for current system state (no history, no planning)

---

## Quick Facts

### URLs
- **Backend API:** https://api.wildfireranch.us
- **Dashboard:** https://dashboard.wildfireranch.us
- **SolArk Inverter:** http://192.168.1.23 (local network)

### Services
- **Backend/Agents:** Railway (FastAPI + CrewAI)
- **Dashboard:** Railway (Streamlit, port 8501)
- **Database:** Railway PostgreSQL 15 + pgvector + TimescaleDB
- **Embeddings:** OpenAI text-embedding-3-small (1536 dimensions)
- **LLM:** OpenAI (via CrewAI)

### Versions
- Python: 3.10+
- CrewAI: Latest
- FastAPI: Latest
- Streamlit: Latest
- PostgreSQL: 15
- pgvector: Latest
- TimescaleDB: Latest

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Streamlit Dashboards                   â”‚
â”‚  Home | System Health | Energy | Chat | Logs        â”‚
â”‚                  (Port 8501)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI Backend (Port 8000)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  KB FAST-PATH (Keyword Detection)            â”‚   â”‚
â”‚  â”‚  Bypasses Manager for docs queries           â”‚   â”‚
â”‚  â”‚  Keywords: specs, threshold, policy, how-to  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                    â”‚
â”‚      â”œâ”€ Direct KB Search (if keyword)               â”‚
â”‚      â”‚                                               â”‚
â”‚      â””â”€ Manager Crew (all other queries)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Manager Agent (Query Router)                â”‚   â”‚
â”‚  â”‚  Tools:                                      â”‚   â”‚
â”‚  â”‚    â€¢ route_to_solar_controller()             â”‚   â”‚
â”‚  â”‚    â€¢ route_to_energy_orchestrator()          â”‚   â”‚
â”‚  â”‚    â€¢ search_kb_directly()                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚    â”‚            â”‚            â”‚                      â”‚
â”‚  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Solar  â”‚ â”‚ Energy  â”‚ â”‚  KB Search   â”‚           â”‚
â”‚  â”‚Control.â”‚ â”‚ Orch.   â”‚ â”‚  (pgvector)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                         â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PostgreSQL â”‚         â”‚  SolArk API     â”‚
â”‚+ pgvector â”‚         â”‚  192.168.1.23   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployed Services

### Railway Backend Service
- **Name:** commandcenter-backend
- **Port:** 8000
- **Components:**
  - FastAPI app
  - CrewAI agents
  - Telemetry collector
  - KB sync service

### Railway Dashboard Service
- **Name:** commandcenter-dashboard
- **Port:** 8501
- **Technology:** Streamlit
- **Pages:** 5 (Home, System Health, Energy Monitor, Agent Chat, Logs)

### Railway Database
- **Type:** PostgreSQL 15
- **Extensions:** pgvector, TimescaleDB
- **Schemas:** agent, solark, public (KB)
- **Tables:** 8 total

---

## API Endpoints

### Core
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/` | GET | API version info |
| `/health` | GET | System health check |
| `/db/init-schema` | POST | Initialize database schema |

### Energy Data
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/energy/latest` | GET | Latest energy snapshot |
| `/energy/stats?hours=24` | GET | Energy statistics (avg, min, max) |

### Agent Chat
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/ask` | POST | Send message to agents (with KB fast-path) |
| `/conversations` | GET | List recent conversations |
| `/conversations/{session_id}` | GET | Get conversation details |

### Knowledge Base
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/kb/sync` | POST | Sync from Google Drive (streaming) |
| `/kb/preview` | POST | Preview sync (dry run) |
| `/kb/search` | POST | Search KB with embeddings |
| `/kb/stats` | GET | KB statistics |
| `/kb/documents` | GET | List all documents |
| `/kb/folders` | GET | Get folder structure |

---

## Database Schema

### Agent Schema (agent.*)

```sql
-- Conversations
CREATE TABLE agent.conversations (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Messages
CREATE TABLE agent.messages (
    id SERIAL PRIMARY KEY,
    conversation_id INTEGER REFERENCES agent.conversations(id),
    role VARCHAR(20) NOT NULL,  -- 'user' or 'assistant'
    content TEXT NOT NULL,
    agent_used VARCHAR(100),
    agent_role VARCHAR(200),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_conversations_session_id ON agent.conversations(session_id);
CREATE INDEX idx_messages_conversation_id ON agent.messages(conversation_id);
CREATE INDEX idx_messages_created_at ON agent.messages(created_at DESC);
```

### SolArk Schema (solark.*)

```sql
-- Telemetry (TimescaleDB hypertable)
CREATE TABLE solark.telemetry (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT NOW(),
    soc FLOAT,              -- Battery SOC (%)
    batt_power FLOAT,       -- Battery power (W)
    pv_power FLOAT,         -- Solar production (W)
    load_power FLOAT,       -- House load (W)
    pv_to_grid FLOAT,       -- Grid export (W)
    grid_to_load FLOAT,     -- Grid import (W)
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_telemetry_timestamp ON solark.telemetry(timestamp DESC);
```

### Knowledge Base Schema (public)

```sql
-- Documents
CREATE TABLE kb_documents (
    id SERIAL PRIMARY KEY,
    google_doc_id VARCHAR(255) UNIQUE,
    title VARCHAR(500),
    folder VARCHAR(500),
    folder_path TEXT,
    mime_type VARCHAR(100),
    full_content TEXT,
    token_count INTEGER,
    is_context_file BOOLEAN DEFAULT FALSE,
    last_synced TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Chunks with embeddings
CREATE TABLE kb_chunks (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES kb_documents(id),
    chunk_text TEXT,
    chunk_index INTEGER,
    token_count INTEGER,
    embedding VECTOR(1536),  -- OpenAI text-embedding-3-small
    created_at TIMESTAMP DEFAULT NOW()
);

-- Sync log
CREATE TABLE kb_sync_log (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(50),
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    status VARCHAR(50),
    documents_processed INTEGER,
    documents_updated INTEGER,
    documents_failed INTEGER,
    error_message TEXT,
    triggered_by VARCHAR(100)
);

-- Vector index
CREATE INDEX kb_chunks_embedding_idx ON kb_chunks
USING ivfflat (embedding vector_cosine_ops);
```

---

## Environment Variables

### Backend (Railway)
```bash
# Required
DATABASE_URL=postgresql://...              # Auto-provided by Railway
OPENAI_API_KEY=<secret>                    # For embeddings + LLM
SOLARK_API_URL=http://192.168.1.23        # Local network
GOOGLE_SERVICE_ACCOUNT_JSON=<secret>       # Google Drive service account
KB_FOLDER_ID=<google-drive-folder-id>     # Target folder for KB sync

# Optional
API_KEY=<secret>                           # Dashboard auth
ALLOWED_ORIGINS=https://dashboard...       # CORS origins
```

### Dashboard (Railway)
```bash
RAILWAY_API_URL=https://api.wildfireranch.us
API_KEY=<secret>
```

---

## Active Agents

### 1. Manager Agent (Query Router)
- **File:** railway/src/agents/manager.py
- **Role:** Query Router and Coordinator
- **Purpose:** Analyze intent and route to specialist
- **Max Iterations:** 3
- **Delegation:** False
- **Tools:**
  - `route_to_solar_controller(query)` - Real-time status
  - `route_to_energy_orchestrator(query)` - Planning/optimization
  - `search_kb_directly(query)` - Documentation

**Routing Logic:**
- Real-time questions (battery, solar, current) â†’ Solar Controller
- Planning questions (should we, optimize) â†’ Energy Orchestrator
- Documentation questions (specs, threshold, how-to) â†’ KB Search

### 2. Solar Controller Agent
- **File:** railway/src/agents/solar_controller.py
- **Role:** Energy Systems Monitor and Status Reporter
- **Purpose:** Answer real-time and historical queries about energy state
- **Response Time:** ~5-6 seconds (real-time), ~3-5s (historical)
- **Tools:**
  - `get_energy_status()` - Current snapshot from SolArk (real-time)
  - `get_detailed_status()` - Detailed current data (raw numbers)
  - `get_historical_stats(hours)` - Time-series statistics (avg, min, max)
  - `get_time_series_data(hours, limit)` - Raw timestamped records
  - `search_knowledge_base()` - Context for explanations

**Example Queries:**
- "What's my battery level?" (uses get_energy_status)
- "How much solar am I producing?" (uses get_energy_status)
- "What was my average solar production yesterday?" (uses get_historical_stats)
- "What time did I hit 2500W yesterday?" (uses get_time_series_data)

### 3. Energy Orchestrator Agent
- **File:** railway/src/agents/energy_orchestrator.py
- **Role:** Energy Operations Manager and Optimization Specialist
- **Purpose:** Make planning and optimization decisions based on real data
- **Response Time:** ~13-15 seconds
- **Tools:**
  - `get_current_status()` - Current energy state
  - `get_historical_stats(hours)` - Time-series statistics for planning context
  - `get_time_series_data(hours, limit)` - Raw timestamped records for pattern analysis
  - `optimize_battery()` - Battery optimization recommendations
  - `coordinate_miners()` - Miner scheduling decisions
  - `create_energy_plan()` - 24-hour energy planning
  - `search_knowledge_base()` - Operating procedures and policies

**Example Queries:**
- "Should we run the miners tonight?" (uses current + historical data)
- "Create an energy plan for today" (uses create_energy_plan + historical patterns)
- "When's the best time to charge the battery?" (uses time-series analysis)

---

## KB Fast-Path System

### Purpose
Bypass Manager agent for documentation queries to achieve sub-second response time.

### Implementation
```python
# src/api/main.py - /ask endpoint
kb_keywords = ['specification', 'specs', 'threshold', 'policy',
               'procedure', 'maintain', 'documentation', 'guide',
               'manual', 'instructions', 'how do i', 'how to']

if any(keyword in query_lower for keyword in kb_keywords):
    # Direct KB search - bypass Manager (400ms vs 20s+)
    result_str = search_knowledge_base.func(query, limit=5)
    agent_used = "Knowledge Base"
    agent_role = "Documentation Search"
else:
    # Manager crew routes to specialist
    crew = create_manager_crew(query, context)
    result = crew.kickoff()
```

### Performance
- **Fast-Path:** 400ms (direct KB search)
- **Routed:** 5-6s (via Manager agent)
- **Improvement:** 50x faster for documentation queries

### Keywords Triggering Fast-Path
- specification, specs
- threshold, policy
- procedure, maintain
- documentation, guide, manual
- instructions, how do i, how to

---

## Knowledge Base Architecture

### Google Drive Sync
- **Service Account:** Used for authentication
- **Root Folder:** Specified by KB_FOLDER_ID
- **Supported Types:** Google Docs, PDFs, Spreadsheets
- **Chunking:** 512 tokens per chunk
- **Embeddings:** OpenAI text-embedding-3-small (1536 dim)

### Sync Process
1. Authenticate with service account
2. Recursively scan target folder
3. Filter to supported file types
4. Check if modified since last_synced (skip if unchanged)
5. Fetch content (format-specific extraction)
6. Chunk into 512-token segments
7. Generate embeddings via OpenAI
8. Upsert to kb_documents table
9. Delete old chunks, insert new chunks
10. Cleanup: Remove documents deleted from Drive
11. Log sync results to kb_sync_log

### Search Process
1. Generate query embedding via OpenAI
2. Cosine similarity search in kb_chunks (pgvector <=> operator)
3. Return top 5 chunks with metadata
4. Format with citations (document title, folder, similarity score)

### Context Files (CONTEXT Folder)
- **Purpose:** Always-loaded baseline knowledge
- **Detection:** Files in /CONTEXT/ folder
- **Flag:** is_context_file = TRUE in database
- **Usage:** High-priority context for agents

---

## Dashboard Pages

### 1. Home (Home.py)
- Quick overview metrics
- SOC, Solar, Load, Grid Export (4 metrics)
- Real-time data from /energy/latest
- Navigation shortcuts

### 2. System Health (1_ğŸ¥_System_Health.py)
- API health check
- Database connectivity
- Service status indicators

### 3. Energy Monitor (2_âš¡_Energy_Monitor.py)
- 5 real-time metrics: SOC, Solar, Load, Battery Power, Grid Export
- 24-hour statistics
- Auto-refresh capability

### 4. Agent Chat (3_ğŸ¤–_Agent_Chat.py)
- Conversational interface to CrewAI agents
- Session management
- Displays agent_used and agent_role metadata
- Multi-turn conversation support

### 5. Logs Viewer (4_ğŸ“Š_Logs_Viewer.py)
- Recent conversation history
- Individual conversation details
- Message inspector

---

## Performance Metrics

| Component | Response Time | Notes |
|-----------|--------------|-------|
| KB Fast-Path | 400ms | Direct search, bypasses Manager |
| KB Routed | 5-6s | Via Manager agent (fallback) |
| Solar Controller | 5-6s | Includes API call to SolArk |
| Energy Orchestrator | 13-15s | Analysis + reasoning |
| Energy API (/latest) | 50-100ms | Direct database query |
| Dashboard Page Load | 1-2s | Includes API calls |

---

## Known Limitations

### Context Passing
- Context currently only available to Manager agent
- Child agents (Solar Controller, Energy Orchestrator) don't receive conversation context
- Workaround: Context embedded in query by Manager when delegating

### KB Fast-Path
- Keyword matching less intelligent than Manager routing
- Trade-off: Speed vs. accuracy
- May miss edge cases that don't use exact keywords

### Agent Metadata
- Manager agent must return tool output verbatim
- KB search returns plain text (not JSON) to prevent parsing attempts
- Metadata extraction relies on structured JSON from routing tools

### File Type Support
- Google Docs: âœ…
- PDFs: âœ…
- Google Sheets: âœ…
- Images: âŒ (no OCR)
- Videos: âŒ

---

## Quick Troubleshooting

### KB Search Returns Empty
1. Check kb_sync_log for recent successful sync
2. Verify embeddings were generated (kb_chunks.embedding NOT NULL)
3. Test query embedding generation (OpenAI API key valid?)
4. Check vector index exists: `\d kb_chunks` in psql

### Agent Timeout
1. Check OPENAI_API_KEY is set
2. Verify OpenAI API is reachable
3. Check Manager agent max_iter (should be 3)
4. Review agent backstory for iteration-causing patterns

### Dashboard Shows No Data
1. Check API_KEY matches between dashboard and backend
2. Verify RAILWAY_API_URL is correct
3. Test /health endpoint directly
4. Check CORS settings (ALLOWED_ORIGINS)

### SolArk Data Missing
1. Verify SOLARK_API_URL is reachable from Railway
2. Check local network access (192.168.1.23)
3. Test /energy/latest endpoint
4. Check telemetry table has recent data

### Conversation Not Persisted
1. Check agent.conversations table exists
2. Verify session_id is being generated
3. Check agent.messages foreign key constraints
4. Review /ask endpoint logging

---

## Deployment

### Railway Backend
```bash
# Deploy from GitHub (main branch)
git push origin main
# Railway auto-deploys from Dockerfile in railway/
```

**Dockerfile Location:** railway/Dockerfile

**Build Command:** `docker build -f railway/Dockerfile .`

**Start Command:** `uvicorn src.api.main:app --host 0.0.0.0 --port 8000`

### Railway Dashboard
**Start Command:** `streamlit run Home.py --server.port 8501`

**Working Directory:** dashboards/

---

## File Locations

### Backend Core
- API: `railway/src/api/main.py`
- Agents: `railway/src/agents/`
- Tools: `railway/src/tools/`
- KB: `railway/src/kb/`
- Database: `railway/src/utils/db.py`

### Dashboard
- Pages: `dashboards/Home.py`, `dashboards/pages/`
- API Client: `dashboards/components/api_client.py`

### Documentation
- Architecture: `docs/05-architecture.md`
- KB Design: `docs/06-knowledge-base-design.md`
- KB Sync: `docs/07-knowledge-base-sync.md`
- Session Summaries: `docs/sessions/`

---

## Recent Changes (V1.5)

### New Features
1. âœ… Grid export display on Home and Energy Monitor
2. âœ… KB fast-path for sub-second documentation queries
3. âœ… Compressed vertical spacing across dashboard pages
4. âœ… Agent metadata extraction (agent_used, agent_role)
5. âœ… Improved conversation history display

### Performance Improvements
1. âœ… KB search: 20s â†’ 400ms (50x faster via fast-path)
2. âœ… Manager agent routing optimized (max_iter: 10 â†’ 3)
3. âœ… Dashboard page load improved

### Architecture Changes
1. âœ… KB fast-path bypass at API level
2. âœ… Manager agent output format standardized (verbatim)
3. âœ… Telemetry schema extended (pv_to_grid field)
4. âœ… Unified CSS across dashboard pages

### Bug Fixes
1. âœ… KB timeout issue resolved (fast-path implementation)
2. âœ… Manager agent iteration loops fixed (max_iter reduction)
3. âœ… Grid export data extraction corrected
4. âœ… Inconsistent vertical spacing resolved

---

## Tool Calling Pattern

### CrewAI @tool Decorator
All tools use the `@tool` decorator:

```python
from crewai.tools import tool

@tool("Tool Name")
def my_tool(param: str) -> str:
    """Tool description for agent."""
    return result
```

### Direct Tool Calls
When calling tools outside of CrewAI context:

```python
# âœ… Correct
result = my_tool.func(param)

# âŒ Wrong (will fail)
result = my_tool(param)
```

### Agent Tool Usage
Agents receive tools in their definition:

```python
agent = Agent(
    role="...",
    goal="...",
    tools=[tool1, tool2, tool3],
    verbose=True
)
```

---

## KB Sync Statistics (Current)

Based on latest production data:
- **Documents Synced:** 15
- **Total Tokens:** 141,889
- **Folders:** 4 (CONTEXT, Bret-ME, SolarShack, Wildfire.Green)
- **Tier 1 (Context):** Files in CONTEXT folder
- **Tier 2 (Full KB):** All other folders

---

## Contact & Support

### Documentation
- **Primary:** This file (V1.5_MASTER_REFERENCE.md)
- **Architecture:** docs/05-architecture.md
- **KB Design:** docs/06-knowledge-base-design.md
- **Session Logs:** docs/sessions/

### Development
- **Repository:** Private GitHub repo
- **Deployment:** Railway (backend + dashboard)
- **Database:** Railway PostgreSQL

---

**End of Master Reference**
**Version 1.5.0 | December 10, 2025**
