# V1.9 Deployment & API Implementation Prompt

**For:** Next Claude Code Session
**Phase:** Week 1, Day 2-4 (Deploy Migration ‚Üí Build API Endpoints)
**Status:** Database migration ready for deployment

---

## üìã Quick Context

I've completed Week 1, Day 1-2 of the V1.9 Implementation Plan. The database migration is **production-ready** and all tests pass.

**What's Done:**
- ‚úÖ Migration file created: `railway/src/database/migrations/006_v1.9_user_preferences.sql`
- ‚úÖ Test suite: 10/10 tests passing
- ‚úÖ Validation script ready
- ‚úÖ Deployment guide complete
- ‚úÖ All Solar Shack defaults verified (45-56V voltage range)

**What's Next:**
1. Deploy migration to Railway (Option 1: Railway CLI)
2. Validate deployment success
3. Build API endpoints (Week 1, Day 3-4)

---

## üéØ Session Goal

Deploy the V1.9 database migration and begin building API endpoints for user preferences, miner profiles, and HVAC zones.

---

## üìö Required Reading (5 minutes)

Load these in order:

1. **[session-036-v1.9-migration-ready.md](docs/sessions/2025-10/session-036-v1.9-migration-ready.md)**
   - Previous session summary
   - What was built
   - Migration details

2. **[V1.9_MIGRATION_DEPLOYMENT_GUIDE.md](docs/versions/v1.9/V1.9_MIGRATION_DEPLOYMENT_GUIDE.md)**
   - Deployment instructions (Railway CLI - Option A)
   - Pre-deployment checklist
   - Validation steps

3. **[V1.9_TECHNICAL_SPECIFICATION.md](docs/versions/v1.9/V1.9_TECHNICAL_SPECIFICATION.md)**
   - Pydantic models (lines 436-483)
   - API endpoints (lines 166-194)
   - Default configuration (lines 238-333)

4. **[V1.9_quick_reference.md](docs/versions/v1.9/V1.9_quick_reference.md)**
   - 5-minute context
   - Key defaults
   - Common mistakes to avoid

---

## üöÄ Tasks for This Session

### Part 1: Deploy Migration (30-45 minutes)

#### Step 1: Pre-Deployment Checklist
```bash
cd /workspaces/CommandCenter/railway

# 1. Verify migration file exists
ls -lh src/database/migrations/006_v1.9_user_preferences.sql

# 2. Verify db.py updated
grep "006_v1.9_user_preferences.sql" src/utils/db.py

# 3. Run test suite one more time
python3 test_v19_migration.py
# Expected: All 10 tests pass
```

#### Step 2: Deploy to Railway (Option 1: Railway CLI)

**IMPORTANT:** I prefer **Option 1 (Railway CLI)** from the deployment guide.

```bash
# Install Railway CLI if needed
npm i -g @railway/cli

# Login and link
railway login
railway link

# BACKUP FIRST (CRITICAL!)
# Note: You may need to manually backup via Railway dashboard
railway run bash -c "echo 'Backup created manually via Railway dashboard'"

# DRY-RUN: Test with ROLLBACK (no actual changes)
railway run bash -c "cat src/database/migrations/006_v1.9_user_preferences.sql | \
  sed 's/COMMIT;/ROLLBACK;/' | \
  psql \$DATABASE_URL"

# Review output - should show all tables created then rolled back

# ACTUAL MIGRATION: Run for real
railway run psql $DATABASE_URL -f src/database/migrations/006_v1.9_user_preferences.sql

# Expected output:
# - CREATE TABLE (4 times)
# - CREATE INDEX (5 times)
# - INSERT (5 times)
# - CREATE TRIGGER (4 times)
# - "V1.9 Migration completed successfully!"
```

#### Step 3: Validate Deployment
```bash
# Run validation script
railway run psql $DATABASE_URL -f validate_v19_migration.sql

# Check for:
# ‚úì All 4 tables exist
# ‚úì 1 user (admin@wildfireranch.us)
# ‚úì 1 preference (45-56V calibration)
# ‚úì 2 miners (Primary S21+, Dump Load S19)
# ‚úì 2 HVAC zones (Heat Room, Main Room)
# ‚úì All constraints valid
```

#### Step 4: Verify V1.8 Still Works
```bash
# Test existing telemetry table
railway run psql $DATABASE_URL -c "SELECT COUNT(*) FROM solark.telemetry;"

# Should return count of existing records (V1.8 data unchanged)
```

---

### Part 2: Build API Endpoints (Week 1, Day 3-4)

Once migration is deployed and validated, continue with API endpoints:

#### Create Pydantic Models
**File:** `railway/src/api/models/v1_9.py` (new file)

Reference: V1.9_TECHNICAL_SPECIFICATION.md lines 436-483

```python
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime

class UserPreferencesBase(BaseModel):
    voltage_at_0_percent: float = Field(default=45.0, ge=40.0, le=50.0)
    voltage_at_100_percent: float = Field(default=56.0, ge=50.0, le=60.0)
    # ... (see technical spec for complete model)

class MinerProfileBase(BaseModel):
    name: str
    power_draw_watts: int
    priority_level: int = Field(ge=1, le=10)
    # ... (see technical spec)

class HVACZoneBase(BaseModel):
    zone_name: str
    zone_type: str
    # ... (see technical spec)
```

#### Create API Routes

**File 1:** `railway/src/api/routes/preferences.py` (new file)
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
# ... implement endpoints

router = APIRouter(prefix="/api/users/preferences", tags=["preferences"])

@router.get("/")
async def get_preferences(db: Session = Depends(get_db)):
    """Get user preferences (voltage thresholds, display settings)"""
    pass

@router.put("/")
async def update_preferences(prefs: UserPreferencesBase, db: Session = Depends(get_db)):
    """Update user preferences"""
    pass

@router.post("/reset")
async def reset_preferences(db: Session = Depends(get_db)):
    """Reset to Solar Shack defaults"""
    pass
```

**File 2:** `railway/src/api/routes/miners.py` (new file)
```python
router = APIRouter(prefix="/api/miners", tags=["miners"])

@router.get("/")
async def list_miners():
    """List all miner profiles"""
    pass

@router.post("/")
async def create_miner(miner: MinerProfileBase):
    """Create new miner profile"""
    pass

@router.get("/{id}")
async def get_miner(id: str):
    """Get single miner by ID"""
    pass

@router.put("/{id}")
async def update_miner(id: str, miner: MinerProfileBase):
    """Update miner profile"""
    pass

@router.delete("/{id}")
async def delete_miner(id: str):
    """Delete miner profile"""
    pass
```

**File 3:** `railway/src/api/routes/hvac.py` (new file)
```python
router = APIRouter(prefix="/api/hvac/zones", tags=["hvac"])

# Same pattern as miners: GET, POST, GET/{id}, PUT/{id}, DELETE/{id}
```

#### Register Routes in main.py
**File:** `railway/src/api/main.py` (modify existing)

```python
from api.routes import preferences, miners, hvac

# Add to existing app
app.include_router(preferences.router)
app.include_router(miners.router)
app.include_router(hvac.router)
```

---

## üìä Success Criteria

### Part 1: Migration Deployed
- [ ] Migration runs without errors
- [ ] All 4 tables exist in database
- [ ] Default data inserted (1+1+2+2 records)
- [ ] All constraints working
- [ ] V1.8 features still functional

### Part 2: API Endpoints Ready
- [ ] Pydantic models created
- [ ] 3 route files created (preferences, miners, hvac)
- [ ] Routes registered in main.py
- [ ] Basic CRUD operations implemented
- [ ] Test with curl/Postman

---

## ‚ö†Ô∏è Important Reminders

### DO:
- ‚úÖ Create database backup before migration
- ‚úÖ Run dry-run first (ROLLBACK test)
- ‚úÖ Use voltage for all decision logic
- ‚úÖ Follow priority-based miner allocation
- ‚úÖ Add comprehensive docstrings
- ‚úÖ Use type hints everywhere

### DON'T:
- ‚ùå Skip backup step
- ‚ùå Use SOC% for decisions (voltage only!)
- ‚ùå Hardcode thresholds (use user preferences)
- ‚ùå Forget validation constraints
- ‚ùå Break V1.8 functionality

### Key Defaults (Solar Shack)
- **Voltage calibration:** 45.0V = 0%, 56.0V = 100%
- **Optimal range:** 50.0V (40%) to 54.5V (80%)
- **Primary miner:** Priority 1, starts at 50.0V
- **Dump load:** Priority 3, starts at 54.5V, requires excess solar
- **HVAC Heat Room:** Cool at 40¬∞C, heat at 0¬∞C, block charging below 0¬∞C

---

## üîç Reference Files

### Migration Files
- `railway/src/database/migrations/006_v1.9_user_preferences.sql` - Migration SQL
- `railway/test_v19_migration.py` - Test suite
- `railway/validate_v19_migration.sql` - Validation queries
- `railway/src/utils/db.py:271` - Migration list (already updated)

### Documentation
- `docs/versions/v1.9/V1.9_IMPLEMENTATION_PLAN.md` - Full 3-week plan
- `docs/versions/v1.9/V1.9_TECHNICAL_SPECIFICATION.md` - Complete specs
- `docs/versions/v1.9/V1.9_MIGRATION_DEPLOYMENT_GUIDE.md` - Deployment instructions
- `docs/versions/v1.9/V1.9_quick_reference.md` - 5-minute guide
- `docs/sessions/2025-10/session-036-v1.9-migration-ready.md` - Previous session

### Existing Code to Reference
- `railway/src/api/main.py` - Existing FastAPI app structure
- `railway/src/api/routes/kb.py` - Example route file
- `railway/src/tools/battery_optimizer.py:1-100` - Current hardcoded thresholds
- `railway/src/agents/energy_orchestrator.py` - Will be updated in Week 1, Day 5

---

## üéØ Expected Timeline

- **Migration deployment:** 30-45 minutes
- **Pydantic models:** 30 minutes
- **API routes (basic):** 2-3 hours
- **Testing:** 30 minutes
- **Total:** 4-5 hours

---

## üìù Session Output

Please create:

1. **Session log:** `docs/sessions/2025-10/session-037-v1.9-api-endpoints.md`
   - Deployment results
   - API endpoints implemented
   - Testing results
   - Next steps

2. **Update INDEX.md:** Add session 037 to latest updates

3. **Continuation prompt:** Prompt for Week 1, Day 5 (Agent Integration)

---

## üöÄ Getting Started

```bash
# 1. Navigate to project
cd /workspaces/CommandCenter/railway

# 2. Read session 036 log
cat ../docs/sessions/2025-10/session-036-v1.9-migration-ready.md

# 3. Read deployment guide
cat ../docs/versions/v1.9/V1.9_MIGRATION_DEPLOYMENT_GUIDE.md

# 4. Begin deployment with backup
railway login
# ... follow deployment steps above
```

---

## üí° Tips

- **Use Railway CLI:** Easier than web dashboard, provides better error messages
- **Test dry-run first:** Catch errors before committing changes
- **Check existing routes:** Look at `kb.py` for FastAPI patterns
- **Reference technical spec:** Complete Pydantic models already documented
- **Voltage is king:** Always use voltage, not SOC%, for decision logic

---

**Ready to deploy!** üöÄ

The migration is thoroughly tested and production-ready. Follow the Railway CLI steps above (Option 1), validate the deployment, then build the API endpoints.

**Status:** Week 1, Day 1-2 ‚úÖ COMPLETE ‚Üí Week 1, Day 2-4 Starting Now

---

**Last Updated:** 2025-10-17
**Previous Session:** 036 - V1.9 Database Migration Ready
**This Session:** 037 - Deploy Migration + Build API Endpoints
**Next Session:** 038 - Agent Integration (Week 1, Day 5)
