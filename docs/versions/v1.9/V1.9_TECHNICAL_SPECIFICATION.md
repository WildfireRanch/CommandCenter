# V1.9 Technical Specification

**Version:** 1.9.0  
**Date:** 2025-10-16  
**Purpose:** Detailed technical reference for V1.9 implementation

---

## 📊 Database Schema

### Table 1: users

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role TEXT DEFAULT 'admin' CHECK (role IN ('admin', 'user')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_login TIMESTAMPTZ
);
```

### Table 2: user_preferences

```sql
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Battery Calibration
    voltage_at_0_percent DECIMAL(4,2) DEFAULT 45.0,
    voltage_at_100_percent DECIMAL(4,2) DEFAULT 56.0,
    voltage_curve JSONB DEFAULT NULL,
    
    -- Battery Specs
    battery_chemistry TEXT DEFAULT 'LiFePO4',
    battery_nominal_voltage DECIMAL(4,2) DEFAULT 51.2,
    battery_absolute_min DECIMAL(4,2) DEFAULT 43.0,
    battery_absolute_max DECIMAL(4,2) DEFAULT 58.8,
    
    -- Operating Thresholds (VOLTAGE)
    voltage_shutdown DECIMAL(4,2) DEFAULT 44.0,
    voltage_critical_low DECIMAL(4,2) DEFAULT 45.0,
    voltage_low DECIMAL(4,2) DEFAULT 47.0,
    voltage_restart DECIMAL(4,2) DEFAULT 50.0,
    voltage_optimal_min DECIMAL(4,2) DEFAULT 50.0,
    voltage_optimal_max DECIMAL(4,2) DEFAULT 54.5,
    voltage_float DECIMAL(4,2) DEFAULT 54.0,
    voltage_absorption DECIMAL(4,2) DEFAULT 57.6,
    voltage_full DECIMAL(4,2) DEFAULT 56.0,
    
    -- Display
    user_prefers_soc_display BOOLEAN DEFAULT true,
    use_custom_soc_mapping BOOLEAN DEFAULT true,
    display_units TEXT DEFAULT 'metric',
    
    -- System
    timezone TEXT DEFAULT 'America/Los_Angeles',
    location_lat DECIMAL(10,7),
    location_lon DECIMAL(10,7),
    operating_mode TEXT DEFAULT 'balanced',
    grid_import_allowed BOOLEAN DEFAULT false,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Table 3: miner_profiles

```sql
CREATE TABLE miner_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Identity
    name TEXT NOT NULL,
    model TEXT,
    hashrate_ths DECIMAL(6,2),
    power_draw_watts INT NOT NULL,
    
    -- Priority & Strategy
    priority_level INT NOT NULL DEFAULT 5,
    operating_mode TEXT NOT NULL DEFAULT 'balanced',
    
    -- Voltage Thresholds
    start_voltage DECIMAL(4,2) NOT NULL,
    stop_voltage DECIMAL(4,2) NOT NULL,
    emergency_stop_voltage DECIMAL(4,2) NOT NULL,
    start_hysteresis_minutes INT DEFAULT 5,
    stop_hysteresis_minutes INT DEFAULT 2,
    
    -- Constraints
    require_excess_solar BOOLEAN DEFAULT false,
    minimum_excess_watts INT,
    maximum_runtime_hours INT,
    
    -- Scheduling
    prefer_time_start INT,
    prefer_time_end INT,
    allow_outside_schedule BOOLEAN DEFAULT true,
    
    -- Weather (V2)
    require_sunny_weather BOOLEAN DEFAULT false,
    minimum_solar_production_watts INT,
    
    -- Status
    enabled BOOLEAN DEFAULT true,
    control_method TEXT,
    device_identifier TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Table 4: hvac_zones

```sql
CREATE TABLE hvac_zones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- Identity
    zone_name TEXT NOT NULL,
    zone_type TEXT NOT NULL,
    
    -- Temperature Thresholds
    temp_too_hot DECIMAL(4,1),
    temp_hot_ok DECIMAL(4,1),
    temp_too_cold DECIMAL(4,1),
    temp_cold_ok DECIMAL(4,1),
    
    -- Cooling
    exhaust_fan_enabled BOOLEAN DEFAULT false,
    exhaust_fan_device_id TEXT,
    exhaust_fan_speed_auto BOOLEAN DEFAULT true,
    exhaust_fan_max_speed INT DEFAULT 10,
    
    -- Heating
    heating_enabled BOOLEAN DEFAULT false,
    heating_priority_1 TEXT,
    heating_priority_2 TEXT,
    heater_device_id TEXT,
    
    -- Constraints
    only_heat_when_solar BOOLEAN DEFAULT true,
    minimum_solar_for_heating_watts INT,
    
    -- Battery Protection
    block_charging_below_temp DECIMAL(4,1),
    
    -- Status
    enabled BOOLEAN DEFAULT true,
    temperature_sensor_id TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 🔧 API Endpoints

### Preferences

```
GET    /api/users/preferences       Get user preferences
PUT    /api/users/preferences       Update preferences
POST   /api/users/preferences/reset Reset to defaults
```

### Miners

```
GET    /api/miners           List all miner profiles
POST   /api/miners           Create miner profile
GET    /api/miners/{id}      Get single miner
PUT    /api/miners/{id}      Update miner
DELETE /api/miners/{id}      Delete miner
```

### HVAC

```
GET    /api/hvac/zones       List all zones
POST   /api/hvac/zones       Create zone
GET    /api/hvac/zones/{id}  Get single zone
PUT    /api/hvac/zones/{id}  Update zone
DELETE /api/hvac/zones/{id}  Delete zone
```

---

## 🧮 Voltage-SOC Conversion Algorithm

```python
class BatteryCalibration:
    """Bidirectional voltage <-> SOC conversion"""
    
    def __init__(self, user_prefs: dict):
        self.v_min = user_prefs['voltage_at_0_percent']   # 45.0V
        self.v_max = user_prefs['voltage_at_100_percent'] # 56.0V
        self.curve = user_prefs.get('voltage_curve', None)
    
    def voltage_to_soc(self, voltage: float) -> float:
        """Convert voltage to SOC%"""
        if voltage <= self.v_min:
            return 0.0
        if voltage >= self.v_max:
            return 100.0
        
        if self.curve:
            return self._interpolate(voltage, self.curve)
        else:
            # Linear interpolation
            return 100.0 * (voltage - self.v_min) / (self.v_max - self.v_min)
    
    def soc_to_voltage(self, soc: float) -> float:
        """Convert SOC% to voltage"""
        if soc <= 0:
            return self.v_min
        if soc >= 100:
            return self.v_max
        
        if self.curve:
            return self._reverse_interpolate(soc, self.curve)
        else:
            # Linear interpolation
            return self.v_min + (soc / 100.0) * (self.v_max - self.v_min)
```

---

## 🎯 Default Configuration (Solar Shack)

```python
DEFAULT_USER = {
    'email': 'admin@wildfireranch.us',
    'role': 'admin'
}

DEFAULT_PREFERENCES = {
    # Calibration
    'voltage_at_0_percent': 45.0,
    'voltage_at_100_percent': 56.0,
    'voltage_curve': [
        {'soc': 0,   'voltage': 45.0},
        {'soc': 15,  'voltage': 47.0},
        {'soc': 40,  'voltage': 50.0},
        {'soc': 60,  'voltage': 52.0},
        {'soc': 80,  'voltage': 54.5},
        {'soc': 100, 'voltage': 56.0}
    ],
    
    # Thresholds
    'voltage_shutdown': 44.0,
    'voltage_critical_low': 45.0,
    'voltage_low': 47.0,
    'voltage_restart': 50.0,
    'voltage_optimal_min': 50.0,
    'voltage_optimal_max': 54.5,
    'voltage_float': 54.0,
    'voltage_absorption': 57.6,
    'voltage_full': 56.0,
    
    # System
    'timezone': 'America/Los_Angeles',
    'location_lat': 37.3382,
    'location_lon': -121.8863,
    'operating_mode': 'balanced'
}

PRIMARY_MINER = {
    'name': 'Primary S21+ (Revenue)',
    'model': 'Antminer S21+ 235TH',
    'hashrate_ths': 235.0,
    'power_draw_watts': 3878,
    'priority_level': 1,
    'operating_mode': 'aggressive',
    'start_voltage': 50.0,
    'stop_voltage': 47.0,
    'emergency_stop_voltage': 45.0,
    'require_excess_solar': False,
    'prefer_time_start': 18,
    'prefer_time_end': 10,
    'allow_outside_schedule': True,
    'control_method': 'smartload'
}

DUMP_LOAD_MINER = {
    'name': 'Dump Load S19 #1',
    'model': 'Antminer S19 95TH',
    'hashrate_ths': 95.0,
    'power_draw_watts': 3250,
    'priority_level': 3,
    'operating_mode': 'opportunistic',
    'start_voltage': 54.5,
    'stop_voltage': 53.0,
    'emergency_stop_voltage': 50.0,
    'require_excess_solar': True,
    'minimum_excess_watts': 3500,
    'minimum_solar_production_watts': 8000,
    'prefer_time_start': 10,
    'prefer_time_end': 16,
    'allow_outside_schedule': False,
    'require_sunny_weather': True,
    'control_method': 'shelly'
}

HEAT_ROOM = {
    'zone_name': 'Heat Room',
    'zone_type': 'equipment',
    'temp_too_hot': 40.0,
    'temp_hot_ok': 35.0,
    'temp_too_cold': 0.0,
    'temp_cold_ok': 5.0,
    'exhaust_fan_enabled': True,
    'exhaust_fan_device_id': 'ac_infinity_1',
    'exhaust_fan_speed_auto': True,
    'exhaust_fan_max_speed': 10,
    'heating_enabled': True,
    'heating_priority_1': 'miner',
    'heating_priority_2': 'heater',
    'heater_device_id': 'shelly_heater_1',
    'only_heat_when_solar': True,
    'minimum_solar_for_heating_watts': 4000,
    'block_charging_below_temp': 0.0
}
```

---

## 🔄 Decision Logic Pseudocode

### Battery Optimizer

```python
def optimize_battery(voltage, time_of_day, weather, user_prefs):
    v_critical = user_prefs['voltage_critical_low']
    v_low = user_prefs['voltage_low']
    v_optimal_min = user_prefs['voltage_optimal_min']
    v_optimal_max = user_prefs['voltage_optimal_max']
    
    if voltage <= v_critical:
        return "CRITICAL: Stop all loads immediately"
    
    if voltage <= v_low:
        return "LOW: Reduce loads, charge battery"
    
    if v_optimal_min <= voltage <= v_optimal_max:
        return "OPTIMAL: Normal operation"
    
    if voltage > v_optimal_max:
        if weather == "sunny" and 8 <= time_of_day <= 16:
            return "HIGH: Can discharge or run high loads"
        else:
            return "MAINTAIN: Hold current level"
```

### Miner Coordinator

```python
def coordinate_miners(voltage, solar, load, miners, user_prefs):
    # Calculate power budget
    available = solar + battery_discharge_allowance(voltage, user_prefs)
    budget = available - load
    
    # Sort by priority (1 = highest)
    sorted_miners = sorted(miners, key=lambda m: m['priority_level'])
    
    decisions = []
    for miner in sorted_miners:
        # Check voltage
        if voltage < miner['start_voltage']:
            decisions.append(f"STOP: {miner['name']} - voltage too low")
            continue
        
        # Check power budget
        if budget < miner['power_draw_watts']:
            decisions.append(f"STOP: {miner['name']} - insufficient power")
            continue
        
        # Check solar requirement (dump loads)
        if miner['require_excess_solar']:
            if solar < miner['minimum_solar_production_watts']:
                decisions.append(f"STOP: {miner['name']} - insufficient solar")
                continue
        
        # All checks passed
        decisions.append(f"START: {miner['name']}")
        budget -= miner['power_draw_watts']
    
    return decisions
```

### HVAC Controller

```python
def control_hvac(zone_temps, solar, zones):
    actions = []
    
    for zone in zones:
        temp = zone_temps[zone['zone_name']]
        
        # Cooling check
        if temp >= zone['temp_too_hot']:
            speed = calculate_fan_speed(temp, zone)
            actions.append(f"Turn on exhaust fan (speed {speed})")
        
        # Heating check
        if temp <= zone['temp_too_cold']:
            if zone['only_heat_when_solar']:
                if solar < zone['minimum_solar_for_heating_watts']:
                    actions.append(f"Need heating but insufficient solar")
                    continue
            
            if zone['heating_priority_1'] == 'miner':
                actions.append(f"Start miner for heat + revenue")
            else:
                actions.append(f"Turn on heater")
        
        # Battery protection
        if temp < zone['block_charging_below_temp']:
            actions.append(f"BLOCK CHARGING - temperature too low")
    
    return actions
```

---

## 📝 Pydantic Models

```python
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime

class UserPreferencesBase(BaseModel):
    voltage_at_0_percent: float = Field(default=45.0, ge=40.0, le=50.0)
    voltage_at_100_percent: float = Field(default=56.0, ge=50.0, le=60.0)
    voltage_shutdown: float = Field(default=44.0)
    voltage_critical_low: float = Field(default=45.0)
    voltage_low: float = Field(default=47.0)
    voltage_restart: float = Field(default=50.0)
    voltage_optimal_min: float = Field(default=50.0)
    voltage_optimal_max: float = Field(default=54.5)
    voltage_float: float = Field(default=54.0)
    voltage_absorption: float = Field(default=57.6)
    voltage_full: float = Field(default=56.0)
    
    timezone: str = Field(default="America/Los_Angeles")
    operating_mode: str = Field(default="balanced")

class MinerProfileBase(BaseModel):
    name: str
    model: Optional[str] = None
    hashrate_ths: Optional[float] = None
    power_draw_watts: int
    priority_level: int = Field(ge=1, le=10)
    operating_mode: str = Field(default="balanced")
    start_voltage: float
    stop_voltage: float
    emergency_stop_voltage: float
    require_excess_solar: bool = False
    minimum_excess_watts: Optional[int] = None
    enabled: bool = True

class HVACZoneBase(BaseModel):
    zone_name: str
    zone_type: str
    temp_too_hot: Optional[float] = None
    temp_hot_ok: Optional[float] = None
    temp_too_cold: Optional[float] = None
    temp_cold_ok: Optional[float] = None
    exhaust_fan_enabled: bool = False
    heating_enabled: bool = False
    heating_priority_1: Optional[str] = None
    enabled: bool = True
```

---

## ✅ Validation Rules

### Voltage Thresholds

```python
def validate_voltage_thresholds(prefs):
    assert prefs['voltage_shutdown'] < prefs['voltage_critical_low']
    assert prefs['voltage_critical_low'] <= prefs['voltage_low']
    assert prefs['voltage_low'] < prefs['voltage_restart']
    assert prefs['voltage_restart'] <= prefs['voltage_optimal_min']
    assert prefs['voltage_optimal_min'] < prefs['voltage_optimal_max']
    assert prefs['voltage_optimal_max'] <= prefs['voltage_float']
    assert prefs['voltage_float'] < prefs['voltage_absorption']
    assert prefs['voltage_absorption'] <= prefs['voltage_full']
```

### Miner Thresholds

```python
def validate_miner_thresholds(miner):
    assert miner['emergency_stop_voltage'] < miner['stop_voltage']
    assert miner['stop_voltage'] < miner['start_voltage']
    assert 1 <= miner['priority_level'] <= 10
```

### Temperature Thresholds

```python
def validate_temp_thresholds(zone):
    if zone['temp_too_cold'] and zone['temp_cold_ok']:
        assert zone['temp_too_cold'] < zone['temp_cold_ok']
    if zone['temp_hot_ok'] and zone['temp_too_hot']:
        assert zone['temp_hot_ok'] < zone['temp_too_hot']
```

---

## 🧪 Test Cases

### Voltage-SOC Conversion

```python
def test_voltage_to_soc():
    prefs = {'voltage_at_0_percent': 45.0, 'voltage_at_100_percent': 56.0}
    converter = BatteryCalibration(prefs)
    
    assert converter.voltage_to_soc(45.0) == 0.0
    assert converter.voltage_to_soc(56.0) == 100.0
    assert abs(converter.voltage_to_soc(50.5) - 50.0) < 2.0  # ±2% tolerance
```

### Miner Priority

```python
def test_miner_priority():
    miners = [
        {'name': 'Dump', 'priority': 3, 'power': 3250},
        {'name': 'Primary', 'priority': 1, 'power': 3878}
    ]
    
    budget = 10000
    decisions = coordinate_miners(52.0, 8000, 1500, miners, prefs)
    
    # Primary should be evaluated first (priority 1)
    assert decisions[0].startswith('START: Primary')
    assert decisions[1].startswith('STOP: Dump')  # Voltage too low
```

### HVAC Logic

```python
def test_hvac_heating():
    zones = [{'zone_name': 'Heat Room', 'temp_too_cold': 0.0, 
              'heating_priority_1': 'miner', 'only_heat_when_solar': True,
              'minimum_solar_for_heating_watts': 4000}]
    
    temps = {'Heat Room': -2.0}
    
    # With sufficient solar
    actions = control_hvac(temps, 5000, zones)
    assert 'Start miner' in actions[0]
    
    # Without sufficient solar
    actions = control_hvac(temps, 2000, zones)
    assert 'insufficient solar' in actions[0]
```

---

**End of Technical Specification**
