# CommandCenter V1.9 Implementation Plan

**Version:** 1.9.0  
**Focus:** User Preferences & Voltage-Based Decision System  
**Timeline:** 3 weeks (15 working days)  
**Status:** Planning Complete, Ready for Implementation

---

## ðŸŽ¯ Executive Summary

V1.9 adds a **preference-driven decision layer** on top of existing V1.5 telemetry collection. Users can customize battery thresholds, miner priorities, and HVAC settings without code changes. All decisions use **voltage as ground truth** with optional SOC display.

**Key Innovation:** Voltage-first architecture - more accurate than SOC%, respects physics.

---

## ðŸ“Š Current State (V1.5)

### What's Already Working
- âœ… Victron integration (voltage, current, temp)
- âœ… SolArk integration (SOC, solar, load, generator)
- âœ… 3 agents (Manager, Solar Controller, Energy Orchestrator)
- âœ… Knowledge base (15 docs, 141K tokens)
- âœ… Conversation persistence
- âœ… Dashboard (Next.js + Vercel)
- âœ… API (FastAPI + Railway)
- âœ… Database (PostgreSQL + TimescaleDB)

### Limitations (V1.5)
- âŒ Hardcoded thresholds (20/40/60/80% SOC)
- âŒ Single miner strategy (can't manage multiple)
- âŒ No per-device voltage thresholds
- âŒ Fixed decision logic (can't customize without code changes)

---

## ðŸš€ V1.9 Goals

### Primary Objectives
1. **Voltage-Based Thresholds** - Replace SOC% with voltage (V) as decision input
2. **Multi-Miner Management** - Priority-based power allocation (primary + dump loads)
3. **HVAC Control Logic** - Temperature-based zone management
4. **User Customization** - All thresholds editable via UI

### Success Criteria
- âœ… Users can set battery thresholds in voltage OR SOC%
- âœ… System supports 3+ miners with different priorities
- âœ… HVAC zones trigger based on temperature thresholds
- âœ… Agents use user preferences (not hardcoded values)
- âœ… All existing V1.5 features continue working
- âœ… Zero data collection changes (uses existing telemetry)

---

## ðŸ—„ï¸ Database Changes

### New Tables (4)

```sql
users
â”œâ”€ id, email, password_hash
â”œâ”€ created_at, updated_at
â””â”€ Single user for V1.9 (multi-user in V2)

user_preferences
â”œâ”€ Voltage calibration (45V=0%, 56V=100%)
â”œâ”€ Operating thresholds (all in voltage)
â”œâ”€ Display preferences (show voltage or SOC)
â””â”€ System settings (timezone, location, units)

miner_profiles
â”œâ”€ Name, model, hashrate, power draw
â”œâ”€ Priority level (1=critical, 3=opportunistic)
â”œâ”€ Voltage thresholds (start, stop, emergency)
â”œâ”€ Solar requirements (excess solar needed)
â””â”€ Scheduling (prefer night, allow daytime)

hvac_zones
â”œâ”€ Zone name (Heat Room, Main Room)
â”œâ”€ Temperature thresholds (too hot, too cold)
â”œâ”€ Cooling devices (exhaust fans)
â”œâ”€ Heating devices (miner/heater priority)
â””â”€ Constraints (only heat when solar available)
```

### Existing Tables (No Changes)
- `solark.plant_flow` - Telemetry storage (unchanged)
- `agent.*` tables - Conversation/memory (unchanged)
- `kb_*` tables - Knowledge base (unchanged)

---

## ðŸ—ï¸ Architecture Changes

### Data Flow (V1.9)

```
Telemetry (V1.5 - Working)
â”œâ”€ Victron: battery_voltage, battery_temp
â”œâ”€ SolArk: pv_power, load_power, battery_soc
â””â”€ PostgreSQL: solark.plant_flow (30s polling)
         â†“
Preferences (V1.9 - New)
â”œâ”€ user_preferences: voltage thresholds
â”œâ”€ miner_profiles: per-miner settings
â””â”€ hvac_zones: temperature thresholds
         â†“
Decision Logic (V1.9 - Enhanced)
â”œâ”€ Energy Orchestrator loads preferences
â”œâ”€ Compares telemetry to user thresholds
â”œâ”€ Returns personalized recommendations
â””â”€ Uses voltage (not SOC) for decisions
         â†“
Response (V1.5 - Working)
â””â”€ Agent responds with context-aware advice
```

### Key Integration Points

1. **Energy Orchestrator Agent** (`railway/src/agents/energy_orchestrator.py`)
   - Load user preferences on initialization
   - Pass preferences to tools
   - Use voltage thresholds in decision logic

2. **Battery Optimizer Tool** (`railway/src/tools/battery_optimizer.py`)
   - Accept voltage + user prefs as parameters
   - Compare current voltage to user thresholds
   - Return recommendations based on user strategy

3. **Miner Coordinator Tool** (`railway/src/tools/miner_coordinator.py`)
   - Evaluate all miner profiles in priority order
   - Allocate power budget by priority
   - Check voltage + solar constraints per miner

4. **New: Voltage-SOC Converter** (`railway/src/services/voltage_soc_converter.py`)
   - Bidirectional conversion (voltage â†” SOC%)
   - Uses user's custom calibration curve
   - Enables dual display (show both units)

---

## ðŸ“… Implementation Timeline

### Week 1: Backend Foundation
**Days 1-2: Database + Migration**
- Create migration script (4 new tables)
- Populate defaults from Solar Shack specs
- Test migration on local PostgreSQL
- Deploy to Railway staging

**Days 3-4: API Endpoints**
- CRUD endpoints for preferences
- CRUD endpoints for miner profiles
- CRUD endpoints for HVAC zones
- Authentication stub (single user)

**Day 5: Context Integration**
- Voltage-SOC converter service
- Update Energy Orchestrator to load preferences
- Update Battery Optimizer to use voltage
- Update Miner Coordinator for multi-miner

### Week 2: Frontend
**Days 1-2: Settings Page Structure**
- New route: `/settings`
- Battery thresholds section (voltage sliders)
- Display toggle (voltage vs SOC)
- Form state management

**Day 3: Miner Management UI**
- Miner profile cards (add/edit/delete)
- Priority visualization
- Voltage threshold sliders
- Solar requirement toggles

**Day 4: HVAC & System Settings**
- HVAC zone cards
- Temperature threshold sliders
- Heating priority selector
- System preferences (timezone, units)

**Day 5: Polish + Responsive**
- Mobile layouts
- Form validation
- Save/cancel/reset buttons
- Loading states

### Week 3: Testing + Deploy
**Days 1-3: Comprehensive Testing**
- Voltage-SOC conversion accuracy
- Miner priority logic with real telemetry
- HVAC decisions with temperature data
- Agent responses use preferences
- Edge cases (invalid inputs, missing data)

**Day 4: Production Deployment**
- Database migration (Railway prod)
- Backend deployment (new endpoints)
- Frontend deployment (settings page)
- Smoke tests (all features)

**Day 5: Monitoring + Buffer**
- Monitor logs for preference usage
- Validate agent decisions
- Collect initial feedback
- Fix any critical issues

---

## ðŸ”§ Technical Specifications

### Voltage Calibration (Key Innovation)

**Problem:** LiFePO4 batteries don't have linear voltage-SOC relationship  
**Solution:** User-defined calibration curve

```python
# User's calibration (from Sol-Ark specs)
voltage_curve = [
    {"soc": 0,   "voltage": 45.0},  # Empty (Batt Empty V + margin)
    {"soc": 15,  "voltage": 47.0},  # Low (Batt Low V)
    {"soc": 40,  "voltage": 50.0},  # Restart (Batt Restart)
    {"soc": 60,  "voltage": 52.0},  # Target (SmartLoad ON)
    {"soc": 80,  "voltage": 54.5},  # High (near Float)
    {"soc": 100, "voltage": 56.0},  # Full (user's 100%)
]

# Linear interpolation between points
def voltage_to_soc(voltage: float) -> float:
    # Find bracketing points and interpolate
    pass
```

### Miner Priority System

**Primary Miner (S21+ 235TH, 3,878W):**
- Priority: 1 (CRITICAL)
- Operating mode: Aggressive
- Voltage range: 50.0V - 56.0V (40% - 100% SOC)
- Strategy: Maximize revenue, run whenever safe

**Dump Load Miners (S19, S9):**
- Priority: 3-4 (OPPORTUNISTIC)
- Operating mode: Opportunistic
- Voltage range: 54.5V+ (>80% SOC only)
- Strategy: Scavenge excess solar, never compete with primary

**Power Allocation Logic:**
```
1. Calculate available power (solar + battery allowance)
2. Subtract house load (always priority)
3. Sort miners by priority (1 = highest)
4. For each miner in order:
   a. Check voltage threshold
   b. Check power budget remaining
   c. Check solar requirements (dump loads only)
   d. Allocate power if all checks pass
5. Return decisions for all miners
```

### HVAC Temperature Management

**Heat Room (Miner Area):**
- Cooling: Exhaust fan ON at 40Â°C, OFF at 35Â°C
- Heating: Miner (preferred) or heater at 0Â°C, OFF at 5Â°C
- Battery protection: Block charging below 0Â°C (LiFePO4 limit)

**Main Room (Equipment/General):**
- Cooling: Exhaust fan ON at 35Â°C, OFF at 30Â°C
- Heating: Heater only (miner heat won't reach)

**Critical Safety Rule:**
- LiFePO4 batteries CANNOT charge below 0Â°C (will damage cells)
- System must block charging if temperature < 0Â°C
- Use miner or heater to warm space before charging

---

## ðŸŽ¨ User Interface Design

### Settings Page Hierarchy

```
/settings
â”œâ”€ âš¡ Battery Management (most important)
â”‚  â”œâ”€ Display: â—‹ Voltage  â— SOC%
â”‚  â”œâ”€ Calibration: 45V = 0%, 56V = 100%
â”‚  â”œâ”€ Critical Low: 45.0V (0%)
â”‚  â”œâ”€ Low: 47.0V (15%)
â”‚  â”œâ”€ Optimal Min: 50.0V (40%)
â”‚  â”œâ”€ Optimal Max: 54.5V (80%)
â”‚  â”œâ”€ Float: 54.0V (75%)
â”‚  â””â”€ Full: 56.0V (100%)
â”‚
â”œâ”€ â›ï¸ Miner Management
â”‚  â”œâ”€ Primary S21+ (Priority 1) [ENABLED]
â”‚  â”‚  â”œâ”€ Power: 3,878W
â”‚  â”‚  â”œâ”€ Start: 50.0V (40%)
â”‚  â”‚  â”œâ”€ Stop: 47.0V (15%)
â”‚  â”‚  â””â”€ Mode: Aggressive Revenue
â”‚  â”‚
â”‚  â”œâ”€ Dump Load S19 (Priority 3) [ENABLED]
â”‚  â”‚  â”œâ”€ Power: 3,250W
â”‚  â”‚  â”œâ”€ Start: 54.5V (80%)
â”‚  â”‚  â”œâ”€ Stop: 53.0V (70%)
â”‚  â”‚  â”œâ”€ Require excess solar: 3,500W
â”‚  â”‚  â””â”€ Mode: Opportunistic
â”‚  â”‚
â”‚  â””â”€ [+ Add Another Miner]
â”‚
â”œâ”€ ðŸŒ¡ï¸ HVAC Control
â”‚  â”œâ”€ Heat Room [ENABLED]
â”‚  â”‚  â”œâ”€ Too Hot: 40Â°C â†’ Exhaust ON
â”‚  â”‚  â”œâ”€ Cool OK: 35Â°C â†’ Exhaust OFF
â”‚  â”‚  â”œâ”€ Too Cold: 0Â°C â†’ Heating ON
â”‚  â”‚  â”œâ”€ Warm OK: 5Â°C â†’ Heating OFF
â”‚  â”‚  â”œâ”€ Heating Priority: â— Miner  â—‹ Heater
â”‚  â”‚  â””â”€ âš ï¸ Block charging below: 0Â°C
â”‚  â”‚
â”‚  â””â”€ Main Room [ENABLED]
â”‚     â”œâ”€ Too Hot: 35Â°C â†’ Exhaust ON
â”‚     â””â”€ Heating: Heater only
â”‚
â””â”€ âš™ï¸ System Preferences
   â”œâ”€ Timezone: America/Los_Angeles
   â”œâ”€ Location: 37.3382, -121.8863
   â”œâ”€ Units: â— Metric  â—‹ Imperial
   â””â”€ Operating Mode: â— Balanced
```

### Visual Components

**Voltage Slider (Dual Display):**
```
Miner Start Threshold
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  52.0V (60%)
45V                56V
```

**Priority Badge:**
```
ðŸ¥‡ Priority 1 (Critical - Runs First)
âš¡ Priority 3 (Opportunistic - Uses Excess)
```

**Status Indicators:**
```
âœ… ENABLED   Current: 52.3V (65%) â†’ RUNNING
â¸ï¸ STANDBY  Current: 49.0V (35%) â†’ WAITING
âŒ DISABLED Manual override
```

---

## ðŸ§ª Testing Strategy

### Unit Tests
- `test_voltage_soc_converter.py` - Conversion accuracy
- `test_miner_coordinator.py` - Priority logic
- `test_hvac_controller.py` - Temperature decisions
- `test_battery_optimizer.py` - Voltage thresholds

### Integration Tests
- Test with real telemetry data (from solark.plant_flow)
- Validate against Sol-Ark specs (from Google Docs)
- Test edge cases (missing data, extreme values)
- Test preference updates (changes take effect immediately)

### End-to-End Tests
- Create user preferences via UI
- Query agent with current telemetry
- Verify agent uses user thresholds (not hardcoded)
- Update preferences, verify agent adapts
- Test all 3 agents (Manager routes correctly)

### User Acceptance Tests
- Load Solar Shack specs as defaults
- Verify matches current system behavior
- Test customization (change thresholds)
- Verify recommendations change appropriately
- Validate voltage-SOC display accuracy

---

## ðŸš¨ Risk Management

### High Risk Items
**Database Migration**
- Risk: Data loss or corruption
- Mitigation: Test on staging first, full backup before prod migration
- Rollback: Keep V1.5 schema backup, can revert if needed

**Voltage-SOC Conversion Accuracy**
- Risk: Incorrect SOC display confuses users
- Mitigation: Validate against known voltage-SOC points from Sol-Ark
- Fallback: Show voltage (ground truth) prominently, SOC as secondary

### Medium Risk Items
**Agent Decision Changes**
- Risk: Agents behave differently with user preferences
- Mitigation: Populate defaults from current hardcoded values
- Testing: Extensive testing with real telemetry before deployment

**UI Complexity**
- Risk: Settings page overwhelming for users
- Mitigation: Collapsible sections, smart defaults, tooltips
- Progressive disclosure: Advanced settings hidden by default

### Low Risk Items
**API Endpoints**
- Risk: Performance impact from preference lookups
- Mitigation: Cache preferences per request, indexed queries

**Frontend State Management**
- Risk: Form state bugs (unsaved changes lost)
- Mitigation: Unsaved changes warning, autosave option

---

## ðŸ“š Documentation Requirements

### Code Documentation
- All new functions with comprehensive docstrings
- Type hints for all parameters
- Examples in docstrings for complex logic
- Inline comments for non-obvious decisions

### User Documentation
- Settings page tooltips (what each threshold means)
- Help modal with voltage-SOC explanation
- Migration guide (for existing V1.5 users)
- FAQ (common questions about customization)

### Technical Documentation
- V1.9_COMPLETION_STATUS.md (after Week 3)
- Database migration guide
- API endpoint documentation
- Architecture decision records

---

## âœ… Definition of Done

### Week 1 (Backend)
- [ ] Database migration tested and deployed
- [ ] All API endpoints working (CRUD for preferences)
- [ ] Voltage-SOC converter service complete
- [ ] Agents load and use user preferences
- [ ] Unit tests passing (80%+ coverage)

### Week 2 (Frontend)
- [ ] Settings page accessible (/settings route)
- [ ] All preference sections functional
- [ ] Form validation working
- [ ] Changes persist to database
- [ ] Mobile responsive

### Week 3 (Testing + Deploy)
- [ ] All tests passing (unit + integration + e2e)
- [ ] Production deployment successful
- [ ] All V1.5 features still working
- [ ] Agent decisions use preferences (not hardcoded)
- [ ] Documentation complete

---

## ðŸŽ¯ Success Metrics

### Technical Metrics
- Zero regressions (V1.5 features work unchanged)
- API response time < 200ms (preference lookups)
- Voltage-SOC conversion accuracy within Â±2%
- Database queries optimized (indexed lookups)

### User Experience Metrics
- Settings page loads in < 1 second
- Preference changes take effect immediately (no restart)
- Agent responses reflect user customization
- Clear error messages for invalid inputs

### System Health Metrics
- No increase in error rate post-deployment
- Database performance stable (query times)
- Memory usage within acceptable limits
- All services healthy (Railway, Vercel)

---

## ðŸ”„ Post-V1.9 (Future)

### V2.0 Features (Enabled by V1.9)
- **Hardware Control**: Preferences provide safety thresholds for automation
- **Real-Time Updates**: WebSocket pushes preference-aware decisions
- **Proactive Alerts**: User thresholds trigger notifications
- **Multi-User**: Expand from single user to family/team

### V2.1+ Features
- **Machine Learning**: Learn optimal thresholds from user behavior
- **Weather Integration**: Adjust thresholds based on forecast
- **Advanced Analytics**: Track how preferences impact performance
- **Mobile App**: Native iOS/Android with push notifications

---

## ðŸ“ž Support & Resources

### Key Files (V1.5 - Existing)
- `railway/src/agents/energy_orchestrator.py` - Main decision agent
- `railway/src/tools/battery_optimizer.py` - Battery recommendations
- `railway/src/tools/miner_coordinator.py` - Miner on/off decisions
- `railway/src/services/solark_client.py` - SolArk telemetry
- `vercel/app/dashboard/page.tsx` - Dashboard frontend

### New Files (V1.9 - To Create)
- `railway/src/services/voltage_soc_converter.py` - Voltage-SOC conversion
- `railway/src/api/routes/preferences.py` - Preference CRUD endpoints
- `railway/src/api/routes/miners.py` - Miner profile endpoints
- `railway/src/api/routes/hvac.py` - HVAC zone endpoints
- `vercel/app/settings/page.tsx` - Settings page
- `railway/migrations/v1.9_user_preferences.sql` - Database migration

### Documentation
- Project Knowledge (Google Docs in KB)
- V1.5 Completion Status
- Session History (sessions 001-034)
- Architecture Docs (05-architecture.md)

### Contact
- Railway Dashboard: app.railway.app
- Vercel Dashboard: vercel.com/dashboard
- API Docs: https://api.wildfireranch.us/docs
- Frontend: https://commandcenter.wildfireranch.us

---

**V1.9 Implementation Plan**  
**Status:** Ready for Development  
**Last Updated:** 2025-10-16
