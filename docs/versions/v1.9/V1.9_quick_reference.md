# V1.9 Quick Reference - 5 Minute Guide

**Purpose:** Fast context when implementing V1.9  
**Read Time:** 5 minutes  

---

## 🎯 TL;DR

Add user preferences for battery thresholds, miner priorities, and HVAC zones. Uses voltage (not SOC%) for all decisions.

**Timeline:** 3 weeks  
**Week 1:** Backend (database + API)  
**Week 2:** Frontend (settings page)  
**Week 3:** Testing + deployment  

---

## 📊 Data Sources (Already Working)

```
Victron → battery_voltage: 52.3V   ⚡ USE THIS (ground truth)
SolArk → pv_power: 8,450W          ☀️ Solar production
SolArk → load_power: 1,850W        🏠 House consumption
SolArk → battery_soc: 62%          📊 Display only (don't use for decisions)

Database: solark.plant_flow (polled every 30s - unchanged)
```

---

## 🆕 What We're Adding (4 Tables)

```
users              → Single admin for V1.9
user_preferences   → Voltage thresholds (45-56V = 0-100%)
miner_profiles     → Priority-based (1=primary, 3=dump load)
hvac_zones         → Temperature thresholds
```

---

## 🔄 How It Works (Example)

```
User asks: "Should I start mining?"

1. Get telemetry: 52.3V, 8450W solar, 1850W load
2. Load preferences: optimal_min=50.0V, optimal_max=54.5V
3. Load miners: 
   - Primary S21: priority=1, start=50.0V
   - Dump Load: priority=3, start=54.5V
4. Calculate: 11,600W available after load
5. Evaluate:
   ✓ Primary: 52.3V ≥ 50.0V → START
   ✗ Dump: 52.3V < 54.5V → WAIT (need >80%)
6. Response: "Start primary S21 (battery at 65%)"
```

---

## 🔧 Files to Create/Modify

**Backend (Week 1):**
```
NEW:
- railway/src/services/voltage_soc_converter.py
- railway/src/api/routes/preferences.py
- railway/src/api/routes/miners.py
- railway/src/api/routes/hvac.py

MODIFY:
- railway/src/agents/energy_orchestrator.py
- railway/src/tools/battery_optimizer.py
- railway/src/tools/miner_coordinator.py
```

**Frontend (Week 2):**
```
NEW:
- vercel/app/settings/page.tsx
- vercel/components/settings/BatterySection.tsx
- vercel/components/settings/MinerSection.tsx
- vercel/components/settings/HVACSection.tsx
- vercel/components/settings/VoltageSlider.tsx
```

---

## 📝 Solar Shack Defaults

```yaml
Battery Calibration:
  45V = 0% SOC
  56V = 100% SOC
  Optimal range: 50.0-54.5V (40-80%)

Primary Miner (Antminer S21+ 235TH):
  Power: 3,878W
  Priority: 1 (runs first)
  Start: 50.0V (40%)
  Stop: 47.0V (15%)
  Strategy: Aggressive (maximize revenue)

Dump Load Miner (S19 95TH):
  Power: 3,250W
  Priority: 3 (runs last)
  Start: 54.5V (80%)
  Stop: 53.0V (70%)
  Requires: 8,000W solar minimum

HVAC:
  Heat Room: 40°C → exhaust, 0°C → heating
  Main Room: 35°C → exhaust
  Heating: Miner preferred (heat + profit)
```

---

## ⚠️ CRITICAL RULES

### DO:
- ✅ Use voltage for decisions (battery_voltage from Victron)
- ✅ Convert voltage → SOC% for display only
- ✅ Test on staging before production
- ✅ Keep V1.5 features working
- ✅ Add type hints + docstrings
- ✅ Write tests (80%+ coverage)

### DON'T:
- ❌ Use SOC% for decisions (it's calculated, not measured)
- ❌ Change existing telemetry collection (plant_flow table)
- ❌ Hardcode thresholds (use user preferences)
- ❌ Break V1.5 functionality
- ❌ Deploy without database backup
- ❌ Skip staging environment testing

---

## 🧪 Testing Checklist

```
Unit Tests:
□ Voltage-SOC converter accuracy (±2%)
□ Miner priority allocation logic
□ HVAC temperature decisions
□ API endpoint validation

Integration Tests:
□ Preferences load from database
□ Agents use voltage thresholds
□ Frontend saves to backend correctly

End-to-End:
□ Create preferences via UI
□ Query agent with real telemetry
□ Verify custom thresholds are used
□ Update preferences, verify immediate effect
```

---

## 🚨 Common Mistakes

**Mistake 1: Using SOC% for decisions**
```python
# ❌ WRONG (SOC is calculated)
if battery_soc > 60:
    start_miner()

# ✅ CORRECT (voltage is measured)
if battery_voltage > user_prefs.start_voltage:
    start_miner()
```

**Mistake 2: Ignoring priority**
```python
# ❌ WRONG (random order)
for miner in miners:
    evaluate(miner)

# ✅ CORRECT (priority order)
sorted_miners = sorted(miners, key=lambda m: m.priority_level)
for miner in sorted_miners:
    if power_budget >= miner.power_draw:
        allocate_power(miner)
        power_budget -= miner.power_draw
```

**Mistake 3: Hardcoding values**
```python
# ❌ WRONG (hardcoded)
BATTERY_LOW = 47.0

# ✅ CORRECT (from preferences)
if voltage < user_prefs.voltage_low:
```

---

## 📞 Quick Help

**Database issues?**  
→ Check V1.9_DATABASE_MIGRATION.sql

**Voltage conversion questions?**  
→ Solar Shack uses 45-56V = 0-100%

**Agent integration unclear?**  
→ Look at railway/src/agents/energy_orchestrator.py

**Frontend component patterns?**  
→ Reference vercel/app/dashboard/page.tsx

**Deployment problems?**  
→ Railway: app.railway.app  
→ Vercel: vercel.com/dashboard

---

## ✅ When Are You Done?

**Backend Complete:**
- ✅ Migration runs without errors
- ✅ All API endpoints return correct data
- ✅ Agents load and use preferences
- ✅ Tests passing (80%+ coverage)

**Frontend Complete:**
- ✅ Settings page accessible at /settings
- ✅ All preference sections editable
- ✅ Voltage/SOC display toggle works
- ✅ Changes save to database
- ✅ Mobile responsive

**V1.9 Shipped:**
- ✅ All tests green (unit + integration + e2e)
- ✅ Production deployed successfully
- ✅ Agent decisions use preferences
- ✅ All V1.5 features still working
- ✅ Documentation updated

---

## 🚀 Getting Started

1. Read **V1.9_IMPLEMENTATION_PLAN.md** (full plan)
2. Follow **V1.9_INITIAL_PROMPT.md** (step-by-step)
3. Run **V1.9_DATABASE_MIGRATION.sql** (staging first!)
4. Reference **V1.9_TECHNICAL_SPECIFICATION.md** (when needed)
5. Use **this guide** for quick lookups

**First Step:** Database migration (Week 1, Day 1-2)

**Remember:**
- Voltage is ground truth
- Test thoroughly at each step
- Maintain V1.5 compatibility
- Done right > done fast

Good luck! 🎉