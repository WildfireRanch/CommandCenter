# V1.9 Quick Reference - 5 Minute Guide

**Purpose:** Fast context when implementing V1.9  
**Read Time:** 5 minutes  

---

## ğŸ¯ TL;DR

Add user preferences for battery thresholds, miner priorities, and HVAC zones. Uses voltage (not SOC%) for all decisions.

**Timeline:** 3 weeks  
**Week 1:** Backend (database + API)  
**Week 2:** Frontend (settings page)  
**Week 3:** Testing + deployment  

---

## ğŸ“Š Data Sources (Already Working)

```
Victron â†’ battery_voltage: 52.3V   âš¡ USE THIS (ground truth)
SolArk â†’ pv_power: 8,450W          â˜€ï¸ Solar production
SolArk â†’ load_power: 1,850W        ğŸ  House consumption
SolArk â†’ battery_soc: 62%          ğŸ“Š Display only (don't use for decisions)

Database: solark.plant_flow (polled every 30s - unchanged)
```

---

## ğŸ†• What We're Adding (4 Tables)

```
users              â†’ Single admin for V1.9
user_preferences   â†’ Voltage thresholds (45-56V = 0-100%)
miner_profiles     â†’ Priority-based (1=primary, 3=dump load)
hvac_zones         â†’ Temperature thresholds
```

---

## ğŸ”„ How It Works (Example)

```
User asks: "Should I start mining?"

1. Get telemetry: 52.3V, 8450W solar, 1850W load
2. Load preferences: optimal_min=50.0V, optimal_max=54.5V
3. Load miners: 
   - Primary S21: priority=1, start=50.0V
   - Dump Load: priority=3, start=54.5V
4. Calculate: 11,600W available after load
5. Evaluate:
   âœ“ Primary: 52.3V â‰¥ 50.0V â†’ START
   âœ— Dump: 52.3V < 54.5V â†’ WAIT (need >80%)
6. Response: "Start primary S21 (battery at 65%)"
```

---

## ğŸ”§ Files to Create/Modify

**Backend (Week 1):**
```
NEW:
- railway/src/services/voltage_soc_converter.py
- railway/src/api/routes/preferences.py
- railway/src/api/routes/miners.py
- railway/src/api/routes/hvac.py

MODIFY:
- railway/src/agents/energy_orchestrator.py
- railway/src/tools/battery_optimizer.py
- railway/src/tools/miner_coordinator.py
```

**Frontend (Week 2):**
```
NEW:
- vercel/app/settings/page.tsx
- vercel/components/settings/BatterySection.tsx
- vercel/components/settings/MinerSection.tsx
- vercel/components/settings/HVACSection.tsx
- vercel/components/settings/VoltageSlider.tsx
```

---

## ğŸ“ Solar Shack Defaults

```yaml
Battery Calibration:
  45V = 0% SOC
  56V = 100% SOC
  Optimal range: 50.0-54.5V (40-80%)

Primary Miner (Antminer S21+ 235TH):
  Power: 3,878W
  Priority: 1 (runs first)
  Start: 50.0V (40%)
  Stop: 47.0V (15%)
  Strategy: Aggressive (maximize revenue)

Dump Load Miner (S19 95TH):
  Power: 3,250W
  Priority: 3 (runs last)
  Start: 54.5V (80%)
  Stop: 53.0V (70%)
  Requires: 8,000W solar minimum

HVAC:
  Heat Room: 40Â°C â†’ exhaust, 0Â°C â†’ heating
  Main Room: 35Â°C â†’ exhaust
  Heating: Miner preferred (heat + profit)
```

---

## âš ï¸ CRITICAL RULES

### DO:
- âœ… Use voltage for decisions (battery_voltage from Victron)
- âœ… Convert voltage â†’ SOC% for display only
- âœ… Test on staging before production
- âœ… Keep V1.5 features working
- âœ… Add type hints + docstrings
- âœ… Write tests (80%+ coverage)

### DON'T:
- âŒ Use SOC% for decisions (it's calculated, not measured)
- âŒ Change existing telemetry collection (plant_flow table)
- âŒ Hardcode thresholds (use user preferences)
- âŒ Break V1.5 functionality
- âŒ Deploy without database backup
- âŒ Skip staging environment testing

---

## ğŸ§ª Testing Checklist

```
Unit Tests:
â–¡ Voltage-SOC converter accuracy (Â±2%)
â–¡ Miner priority allocation logic
â–¡ HVAC temperature decisions
â–¡ API endpoint validation

Integration Tests:
â–¡ Preferences load from database
â–¡ Agents use voltage thresholds
â–¡ Frontend saves to backend correctly

End-to-End:
â–¡ Create preferences via UI
â–¡ Query agent with real telemetry
â–¡ Verify custom thresholds are used
â–¡ Update preferences, verify immediate effect
```

---

## ğŸš¨ Common Mistakes

**Mistake 1: Using SOC% for decisions**
```python
# âŒ WRONG (SOC is calculated)
if battery_soc > 60:
    start_miner()

# âœ… CORRECT (voltage is measured)
if battery_voltage > user_prefs.start_voltage:
    start_miner()
```

**Mistake 2: Ignoring priority**
```python
# âŒ WRONG (random order)
for miner in miners:
    evaluate(miner)

# âœ… CORRECT (priority order)
sorted_miners = sorted(miners, key=lambda m: m.priority_level)
for miner in sorted_miners:
    if power_budget >= miner.power_draw:
        allocate_power(miner)
        power_budget -= miner.power_draw
```

**Mistake 3: Hardcoding values**
```python
# âŒ WRONG (hardcoded)
BATTERY_LOW = 47.0

# âœ… CORRECT (from preferences)
if voltage < user_prefs.voltage_low:
```

---

## ğŸ“ Quick Help

**Database issues?**  
â†’ Check V1.9_DATABASE_MIGRATION.sql

**Voltage conversion questions?**  
â†’ Solar Shack uses 45-56V = 0-100%

**Agent integration unclear?**  
â†’ Look at railway/src/agents/energy_orchestrator.py

**Frontend component patterns?**  
â†’ Reference vercel/app/dashboard/page.tsx

**Deployment problems?**  
â†’ Railway: app.railway.app  
â†’ Vercel: vercel.com/dashboard

---

## âœ… When Are You Done?

**Backend Complete:**
- âœ… Migration runs without errors
- âœ… All API endpoints return correct data
- âœ… Agents load and use preferences
- âœ… Tests passing (80%+ coverage)

**Frontend Complete:**
- âœ… Settings page accessible at /settings
- âœ… All preference sections editable
- âœ… Voltage/SOC display toggle works
- âœ… Changes save to database
- âœ… Mobile responsive

**V1.9 Shipped:**
- âœ… All tests green (unit + integration + e2e)
- âœ… Production deployed successfully
- âœ… Agent decisions use preferences
- âœ… All V1.5 features still working
- âœ… Documentation updated

---

## ğŸš€ Getting Started

1. Read **V1.9_IMPLEMENTATION_PLAN.md** (full plan)
2. Follow **V1.9_INITIAL_PROMPT.md** (step-by-step)
3. Run **V1.9_DATABASE_MIGRATION.sql** (staging first!)
4. Reference **V1.9_TECHNICAL_SPECIFICATION.md** (when needed)
5. Use **this guide** for quick lookups

**First Step:** Database migration (Week 1, Day 1-2)

**Remember:**
- Voltage is ground truth
- Test thoroughly at each step
- Maintain V1.5 compatibility
- Done right > done fast

Good luck! ğŸ‰