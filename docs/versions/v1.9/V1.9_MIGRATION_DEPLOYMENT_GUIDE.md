# V1.9 Migration Deployment Guide

**Version:** 1.9.0
**Migration:** 006_v1.9_user_preferences.sql
**Date:** 2025-10-17
**Status:** ‚úÖ Ready for Deployment

---

## üìã Pre-Deployment Checklist

### ‚úÖ Preparation Complete
- [x] Migration file created: `006_v1.9_user_preferences.sql`
- [x] Test suite passed: All 10 validation tests green
- [x] db.py updated with migration file reference
- [x] Validation script ready: `validate_v19_migration.sql`
- [x] Rollback script included in migration file

### ‚ö†Ô∏è Pre-Deployment Requirements
- [ ] Database backup created (CRITICAL!)
- [ ] Railway CLI installed and authenticated
- [ ] Staging environment tested (if available)
- [ ] All stakeholders notified of deployment window

---

## üöÄ Deployment Options

### Option A: Railway CLI (Recommended for Production)

**Step 1: Install Railway CLI**
```bash
# Install Railway CLI (if not installed)
npm i -g @railway/cli

# Login to Railway
railway login
```

**Step 2: Link to Project**
```bash
# Link to CommandCenter project
railway link

# Verify connection
railway status
```

**Step 3: Backup Database**
```bash
# Create database backup (CRITICAL!)
railway run psql $DATABASE_URL -c "\copy (SELECT * FROM pg_dump_all()) TO '/tmp/backup_$(date +%Y%m%d).sql'"

# Or use Railway dashboard:
# https://railway.app/project/<project-id>/service/<postgres-id>/backups
```

**Step 4: Run Migration (DRY-RUN first)**
```bash
# DRY-RUN: Test migration with ROLLBACK
railway run bash -c "cat src/database/migrations/006_v1.9_user_preferences.sql | \
  sed 's/COMMIT;/ROLLBACK;/' | \
  psql \$DATABASE_URL"

# Review output - should see all tables created, then rolled back
```

**Step 5: Run Actual Migration**
```bash
# PRODUCTION: Run migration for real
railway run psql $DATABASE_URL -f src/database/migrations/006_v1.9_user_preferences.sql

# Should see output:
# - CREATE TABLE (4 times)
# - CREATE INDEX (5 times)
# - INSERT (5 times)
# - CREATE TRIGGER (4 times)
# - "V1.9 Migration completed successfully!"
```

**Step 6: Validate Migration**
```bash
# Run validation script
railway run psql $DATABASE_URL -f validate_v19_migration.sql

# Expected output:
# - All 4 tables exist ‚úì
# - 1 user, 1 preference, 2 miners, 2 HVAC zones ‚úì
# - All constraints valid ‚úì
```

---

### Option B: Python Migration Runner (Alternative)

**Step 1: Use db.py init_schema()**
```bash
# From railway/ directory
cd /workspaces/CommandCenter/railway

# Run migration via Python
railway run python3 -c "
from src.utils.db import init_schema
init_schema()
"

# Migration 006 will run automatically
```

**Step 2: Verify**
```bash
railway run python3 -c "
from src.utils.db import get_connection, query_all

with get_connection() as conn:
    # Check tables
    tables = query_all(conn, '''
        SELECT table_name FROM information_schema.tables
        WHERE table_name IN ('users', 'user_preferences', 'miner_profiles', 'hvac_zones')
    ''')
    print(f'Tables created: {len(tables)}/4')

    # Check default user
    users = query_all(conn, 'SELECT email FROM users')
    print(f'Users: {users}')
"
```

---

### Option C: Railway Dashboard (Web UI)

**Step 1: Access Database**
1. Go to [Railway Dashboard](https://railway.app)
2. Navigate to CommandCenter project
3. Click on PostgreSQL service
4. Click "Query" tab

**Step 2: Run Migration**
1. Copy contents of `006_v1.9_user_preferences.sql`
2. Paste into query editor
3. Click "Run Query"
4. Verify output shows successful creation

**Step 3: Validate**
1. Run validation queries from `validate_v19_migration.sql`
2. Verify all tables exist with correct data

---

## üîç Validation Checklist

After migration runs, verify:

### Table Existence
```sql
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('users', 'user_preferences', 'miner_profiles', 'hvac_zones');
```
**Expected:** 4 rows

### Default User
```sql
SELECT email, role FROM users;
```
**Expected:** admin@wildfireranch.us, admin

### Voltage Calibration
```sql
SELECT voltage_at_0_percent, voltage_at_100_percent,
       voltage_optimal_min, voltage_optimal_max
FROM user_preferences;
```
**Expected:** 45.0, 56.0, 50.0, 54.5

### Miner Profiles
```sql
SELECT name, priority_level, start_voltage, require_excess_solar
FROM miner_profiles ORDER BY priority_level;
```
**Expected:**
- Primary S21+: priority=1, start=50.0, excess_solar=false
- Dump Load S19: priority=3, start=54.5, excess_solar=true

### HVAC Zones
```sql
SELECT zone_name, temp_too_hot, temp_too_cold FROM hvac_zones;
```
**Expected:**
- Heat Room: 40.0¬∞C (hot), 0.0¬∞C (cold)
- Main Room: 35.0¬∞C (hot), -5.0¬∞C (cold)

### Constraint Test
```sql
-- Try to insert invalid data (should fail)
INSERT INTO user_preferences (user_id, voltage_at_0_percent, voltage_at_100_percent)
VALUES ('a0000000-0000-0000-0000-000000000001'::uuid, 56.0, 45.0);
```
**Expected:** ERROR: violates check constraint "valid_voltage_calibration"

---

## üîß Troubleshooting

### Issue: "relation already exists"
**Cause:** Migration already ran (tables exist)
**Solution:** Check if tables have data:
```sql
SELECT COUNT(*) FROM users;
```
If data exists, migration succeeded. If empty, run INSERT statements manually.

### Issue: "could not translate host name"
**Cause:** Not connected to Railway network
**Solution:** Use `railway run` prefix for all commands

### Issue: "constraint violation"
**Cause:** Invalid default data
**Solution:** Check voltage values in INSERT statements match constraints

### Issue: "function already exists"
**Cause:** `update_updated_at_column()` function already exists
**Solution:** Safe to ignore - function is created as `CREATE OR REPLACE`

---

## üîÑ Rollback Procedure

If migration causes issues:

**Step 1: Stop Application**
```bash
railway down --service CommandCenter
```

**Step 2: Run Rollback Script**
```bash
railway run psql $DATABASE_URL << 'EOF'
BEGIN;
DROP TABLE IF EXISTS hvac_zones CASCADE;
DROP TABLE IF EXISTS miner_profiles CASCADE;
DROP TABLE IF EXISTS user_preferences CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;
DELETE FROM schema_migrations WHERE version = 'v1.9.0';
COMMIT;
EOF
```

**Step 3: Verify Rollback**
```bash
railway run psql $DATABASE_URL -c "SELECT * FROM users"
# Should error: relation "users" does not exist
```

**Step 4: Restore from Backup**
```bash
railway run psql $DATABASE_URL < /tmp/backup_YYYYMMDD.sql
```

---

## üìä Post-Deployment Verification

### 1. Check Application Logs
```bash
railway logs --service CommandCenter

# Look for:
# ‚úÖ "Database connection successful"
# ‚úÖ "Migration 006 completed"
# ‚ùå No errors about missing tables
```

### 2. Test API Endpoints (Week 1, Day 3)
```bash
# After API endpoints are created:
curl https://api.wildfireranch.us/api/users/preferences
# Expected: 200 OK with preference data
```

### 3. Verify V1.5 Features Still Work
```bash
# Test existing SolArk telemetry
railway run python3 -c "
from src.utils.db import get_connection, query_one
with get_connection() as conn:
    result = query_one(conn, 'SELECT COUNT(*) as count FROM solark.telemetry')
    print(f'Telemetry records: {result[\"count\"]}')
"
# Should show existing data unchanged
```

---

## üìù Deployment Timeline

### Staging (Optional)
- **When:** Before production
- **How:** Deploy to staging Railway environment first
- **Verify:** Run full validation suite

### Production
- **When:** After successful staging test OR comprehensive local testing
- **Window:** Low-traffic period (suggested: evening/weekend)
- **Duration:** ~5-10 minutes
- **Downtime:** None (migration is additive, doesn't modify existing tables)

---

## ‚úÖ Success Criteria

Migration is successful when:

- [ ] All 4 tables created (users, user_preferences, miner_profiles, hvac_zones)
- [ ] All indexes created (5 total)
- [ ] All constraints working (voltage ranges, priorities, foreign keys)
- [ ] All triggers created (4 total)
- [ ] Default data inserted (1 user, 1 pref, 2 miners, 2 HVAC zones)
- [ ] Validation script passes 100%
- [ ] V1.5 features still working (solark.*, agent.* tables unchanged)
- [ ] No errors in Railway logs
- [ ] `schema_migrations` table shows v1.9.0

---

## üéØ Next Steps (After Migration)

### Week 1, Day 3-4: API Endpoints
- Create CRUD endpoints for preferences
- Create CRUD endpoints for miner profiles
- Create CRUD endpoints for HVAC zones
- Test endpoints with Postman/curl

### Week 1, Day 5: Agent Integration
- Create voltage-SOC converter service
- Update Energy Orchestrator to load preferences
- Update Battery Optimizer to use voltage
- Update Miner Coordinator for multi-miner support

---

## üìû Support & Resources

**Railway Dashboard:** https://railway.app
**Database Service:** CommandCenter ‚Üí PostgreSQL
**Migration File:** `railway/src/database/migrations/006_v1.9_user_preferences.sql`
**Validation Script:** `railway/validate_v19_migration.sql`
**Test Suite:** `railway/test_v19_migration.py`

**Documentation:**
- V1.9 Implementation Plan: `docs/versions/v1.9/V1.9_IMPLEMENTATION_PLAN.md`
- V1.9 Technical Spec: `docs/versions/v1.9/V1.9_TECHNICAL_SPECIFICATION.md`
- Quick Reference: `docs/versions/v1.9/V1.9_quick_reference.md`

---

**Migration Status:** ‚úÖ Ready for Deployment
**Last Updated:** 2025-10-17
**Author:** Claude Code
**Session:** 035 - V1.9 Implementation
