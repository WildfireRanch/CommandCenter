# V1.6 Context Management - Completion Plan

**Status:** Code Deployed, Validation Pending
**Target:** Complete V1.6 and prepare for V2.0
**Timeline:** 2-3 hours

---

## Current Status

### âœ… Completed
- Code changes implemented (Fix #1: context loading, Fix #2: routing)
- Committed to git (004576a1)
- Pushed to production
- Railway deployment triggered

### â³ In Progress
- Railway deployment (should complete within 5 min)
- Production validation pending

### âŒ Blocked
- No context files in production database (highly likely)
- Cannot validate until deployment completes

---

## Phase 1: Complete V1.6 Deployment (30 min)

### Step 1.1: Confirm Deployment Complete (5 min)

```bash
# Check deployment status
railway logs --service CommandCenter | grep "Application startup complete"

# Expected: "INFO:     Application startup complete."
```

**Success Criteria:**
- âœ… Logs show startup complete
- âœ… No errors in last 50 lines
- âœ… API responds to /health check

---

### Step 1.2: Test V1.6 Behavior (5 min)

**Test A: System Knowledge**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What inverter are you managing?"}' \
  | jq -r '.response' | head -5
```

**Expected if V1.6 working + context exists:**
> "I'm managing a SolArk 15K Hybrid Inverter..."

**Expected if context files missing:**
> "not explicitly found... check physical unit..."

---

**Test B: Policy Knowledge**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What is the minimum battery SOC?"}' \
  | jq '.agent_role'
```

**Expected if V1.6 working:**
- agent_role: "Solar Controller" or "Manager" (NOT "Knowledge Base")
- Direct answer, not KB search results

---

### Step 1.3: Create Context Files in Production (15 min)

**If tests still fail, context files don't exist. Create them:**

**Option A: Via API** (Recommended if API endpoint exists)
```bash
curl -X POST https://api.wildfireranch.us/kb/documents \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $API_KEY" \
  -d @- <<'EOF'
{
  "title": "CommandCenter System Specifications",
  "content": "# CommandCenter V1.5 System Specifications

## Hardware

**Inverter:** SolArk 15K Hybrid Inverter
- Model: 15K-2P-N
- Continuous Power: 15kW
- Surge Power: 20kW
- Type: Hybrid inverter/charger with built-in solar MPPT

**Battery Bank:** LiFePO4 (Lithium Iron Phosphate)
- Total Capacity: 48 kWh
- Nominal Voltage: 51.2V (48V system)
- Chemistry: LiFePO4 (safer, longer life than Li-ion)
- Configuration: Custom bank with BMS

**Solar Array:** 14.6 kW PV System
- Panel Count: 36 panels
- Panel Wattage: 405W each
- Total Capacity: 14.6 kW DC
- Configuration: Optimized for SolArk MPPT input

**Bitcoin Miners:** Antminer S19 Fleet
- Miner Count: 5 units
- Model: Antminer S19
- Power per Unit: 3.25 kW (3,250W)
- Total Fleet Power: 16.25 kW
- Control: Via Shelly Plug S smart outlets

## Capabilities

**Monitoring:**
- Real-time battery State of Charge (SOC) monitoring
- Real-time solar production (PV power)
- Real-time load consumption
- Grid import/export tracking
- Historical data analysis via PostgreSQL + TimescaleDB

**Control:**
- Bitcoin miner on/off control (via Shelly smart plugs)
- Energy planning and optimization recommendations
- Battery charge/discharge monitoring

**Cannot Control:**
- SolArk inverter settings (read-only API access)
- Battery charge parameters (managed by SolArk BMS)
- Individual household appliances (except miners)
- Weather or grid conditions

## Operating Policies

**Battery Management:**
- Critical Minimum SOC: 30% (NEVER go below)
- Safe Minimum SOC: 40% (operating floor)
- Safe Maximum SOC: 80% (daily cycling ceiling)
- Absolute Maximum: 100% (occasional full charge okay)

**Grid Usage:**
- Policy: Minimize grid import
- Emergency Only: Import from grid only when battery < 40% and no solar
- Export: Okay when battery full and excess solar

**Miner Operation:**
- Priority: Run only with excess solar power
- Minimum Battery SOC: 50% (don't run miners if battery below this)
- Scheduling: Optimize for solar production hours

## Location
- Installation: Wildfire Ranch (off-grid residential)
- System Type: Solar + battery + grid backup
- Primary Goal: Energy independence with Bitcoin mining using excess solar",
  "is_context_file": true
}
EOF
```

**Option B: Via Python Script**
```python
# Save as railway/scripts/create_context.py
import psycopg2
import os

CONTEXT_CONTENT = """# CommandCenter V1.5 System Specifications

[Same content as above]
"""

conn = psycopg2.connect(os.environ['DATABASE_URL'])
cur = conn.cursor()

cur.execute("""
INSERT INTO kb_documents (title, full_content, is_context_file, folder, folder_path, mime_type)
VALUES (%s, %s, TRUE, 'CONTEXT', '/CONTEXT/', 'text/plain')
ON CONFLICT (google_doc_id) DO NOTHING
""", ("CommandCenter System Specifications", CONTEXT_CONTENT))

conn.commit()
print(f"âœ… Created context file")

cur.execute("SELECT COUNT(*) FROM kb_documents WHERE is_context_file = TRUE")
count = cur.fetchone()[0]
print(f"ðŸ“Š Total context files: {count}")

cur.close()
conn.close()
```

Run via Railway:
```bash
cd railway
railway run python scripts/create_context.py
```

---

### Step 1.4: Verify Context Loaded (5 min)

**Test again after creating context:**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What inverter are you managing?"}' \
  | jq -r '.response' | head -3
```

**Success Criteria:**
- âœ… Mentions "SolArk 15K"
- âœ… Response time <8 seconds
- âœ… No "not found" or "check physical unit"

---

## Phase 2: End-to-End Testing (V1.5 + V1.6) (60 min)

### Test Suite 1: Core Functionality (V1.5 Regression)

**Test 1: API Health**
```bash
curl https://api.wildfireranch.us/health | jq
```
Expected: `{"status": "healthy", ...}`

---

**Test 2: Energy Data**
```bash
curl https://api.wildfireranch.us/energy/latest | jq
```
Expected: Current SOC, solar_power, load_power, etc.

---

**Test 3: KB Search (Direct)**
```bash
curl -X POST https://api.wildfireranch.us/kb/search \
  -H "Content-Type: application/json" \
  -d '{"query": "minimum battery SOC", "limit": 3}' | jq
```
Expected: Relevant chunks with similarity scores

---

**Test 4: KB Fast-Path**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What are the specifications for the inverter?"}' \
  | jq '.agent_role, .duration_ms'
```
Expected:
- agent_role: "Knowledge Base" (fast-path triggered)
- duration_ms: <1000 (sub-second)

---

### Test Suite 2: Agent Intelligence (V1.6 New)

**Test 5: System Knowledge (V1.6)**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "Describe your system hardware"}' \
  | jq -r '.response' | head -10
```
âœ… PASS: Lists SolArk 15K, 48kWh battery, 14.6kW solar, 5 miners
âŒ FAIL: Generic or "not found"

---

**Test 6: Policy Knowledge (V1.6)**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What is the critical minimum battery SOC?"}' \
  | jq -r '.response, .agent_role'
```
âœ… PASS: "30%", agent NOT "Knowledge Base"
âŒ FAIL: KB search performed

---

**Test 7: Multi-Turn Context (V1.6)**
```bash
# Turn 1
SID=$(curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "What is my battery level?"}' | jq -r '.session_id')

echo "Session: $SID"

# Turn 2
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d "{\"message\": \"Is that level safe for running miners?\", \"session_id\": \"$SID\"}" \
  | jq -r '.response' | head -5
```
âœ… PASS: References specific battery level from Turn 1
âŒ FAIL: "What level?" or no reference

---

**Test 8: Capability Boundaries (V1.6)**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "Can you change my inverter charge voltage?"}' \
  | jq -r '.response' | head -5
```
âœ… PASS: States cannot control inverter settings
âŒ FAIL: Suggests it can or doesn't mention limitation

---

### Test Suite 3: Routing & Orchestration

**Test 9: Solar Controller Routing**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "How much solar am I producing right now?"}' \
  | jq '.agent_role, .duration_ms'
```
âœ… PASS: agent_role: "Energy Systems Monitor", duration <10s
âŒ FAIL: Wrong agent or timeout

---

**Test 10: Energy Orchestrator Routing**
```bash
curl -s -X POST https://api.wildfireranch.us/ask \
  -H "Content-Type: application/json" \
  -d '{"message": "Should I run the miners tonight?"}' \
  | jq '.agent_role, .duration_ms'
```
âœ… PASS: agent_role: "Energy Operations Manager", duration <20s
âŒ FAIL: Wrong agent or timeout

---

### Test Suite 4: Performance

**Test 11: Response Time Baseline**
```bash
# Run 5 queries, measure average
for i in {1..5}; do
  curl -s -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is my battery level?"}' \
    -w "Time: %{time_total}s\n" \
    -o /dev/null
done | grep "Time:" | awk '{sum+=$2; count++} END {print "Average:", sum/count, "seconds"}'
```
âœ… PASS: Average <8 seconds
âš ï¸ WARNING: 8-15 seconds
âŒ FAIL: >15 seconds

---

**Test 12: Token Usage**
```sql
-- Check average token usage after V1.6
SELECT
  AVG(LENGTH(content)) / 4 as avg_tokens_estimate,
  MAX(LENGTH(content)) / 4 as max_tokens_estimate
FROM agent.messages
WHERE created_at > NOW() - INTERVAL '1 hour'
  AND role = 'assistant';
```
âœ… PASS: Average 5k-8k tokens
âš ï¸ WARNING: 8k-10k tokens
âŒ FAIL: >10k tokens

---

## Phase 3: V2.0 Roadmap Planning (30 min)

### V2.0 Goals (Based on V1.5 + V1.6 Foundation)

#### Goal 1: Unified Agent Architecture
**Current:** 3 separate crews (Manager, Solar Controller, Orchestrator)
**Target:** Single hierarchical crew with proper delegation

**Benefits:**
- Context automatically shared
- More efficient routing
- Better multi-agent coordination

---

#### Goal 2: Smart Context Loading
**Current:** All context files loaded every request
**Target:** Query-relevant context only

**Benefits:**
- Lower token usage
- Faster responses
- Scales with more context docs

---

#### Goal 3: Proactive Monitoring & Alerts
**Current:** Reactive (user asks questions)
**Target:** Proactive (agent alerts on issues)

**Features:**
- Battery low alerts
- Solar production anomalies
- Grid import warnings
- Miner performance issues

---

#### Goal 4: Victron Integration
**Current:** SolArk only
**Target:** Multi-inverter support

**New Hardware:**
- Victron Cerbo GX integration
- VRM portal data access
- MQTT support for real-time data

---

#### Goal 5: Advanced Planning
**Current:** Simple recommendations
**Target:** ML-based optimization

**Features:**
- Weather forecast integration
- Energy price forecasting
- Battery degradation modeling
- Predictive maintenance

---

#### Goal 6: User Preferences
**Current:** Fixed policies
**Target:** Per-user customization

**Features:**
- Custom SOC thresholds
- Miner scheduling preferences
- Alert preferences
- Language/timezone settings

---

### V2.0 Architecture Vision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   UNIFIED AGENT CREW                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Master Agent (Hierarchical Manager)                   â”‚ â”‚
â”‚  â”‚ - Context: Smart loading (query-relevant only)        â”‚ â”‚
â”‚  â”‚ - Delegation: Native CrewAI hierarchical process      â”‚ â”‚
â”‚  â”‚ - Memory: Conversation + user preferences             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚        â”‚        â”‚            â”‚              â”‚          â”‚
â”‚  â”Œâ–¼â”€â”€â”  â”Œâ”€â–¼â”€â”   â”Œâ”€â”€â–¼â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Monâ”‚  â”‚Solâ”‚   â”‚Orchâ”‚      â”‚Victr.â”‚      â”‚Weather â”‚     â”‚
â”‚  â”‚itorâ”‚ â”‚Ctrlâ”‚  â”‚estrâ”‚      â”‚Agent â”‚      â”‚Agent   â”‚     â”‚
â”‚  â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
         â”‚PostgreSQLâ”‚    â”‚SolArk API â”‚   â”‚Victron   â”‚
         â”‚+ Vector  â”‚    â”‚Local Net  â”‚   â”‚VRM API   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 4: Production Validation Report (10 min)

### Create Validation Report

```bash
# Save results
cat > /tmp/v16_validation_results.txt <<EOF
# V1.6 Validation Results
Date: $(date)

## Deployment
- Code Version: 004576a1
- Deployment Time: [FILL IN]
- Deployment Status: [SUCCESS/FAILED]

## Test Results
Test 1 (API Health): [PASS/FAIL]
Test 2 (Energy Data): [PASS/FAIL]
Test 3 (KB Search): [PASS/FAIL]
Test 4 (KB Fast-Path): [PASS/FAIL]
Test 5 (System Knowledge): [PASS/FAIL]
Test 6 (Policy Knowledge): [PASS/FAIL]
Test 7 (Multi-Turn Context): [PASS/FAIL]
Test 8 (Capability Boundaries): [PASS/FAIL]
Test 9 (Solar Controller Routing): [PASS/FAIL]
Test 10 (Energy Orchestrator Routing): [PASS/FAIL]
Test 11 (Performance): [PASS/FAIL] - Avg: [X]s
Test 12 (Token Usage): [PASS/FAIL] - Avg: [X]k tokens

## Pass Rate: [X]/12 tests

## Critical Issues
[List any critical failures]

## Recommendations
[Next steps]

## V2.0 Readiness
- Architecture: [READY/NOT READY]
- Performance: [READY/NOT READY]
- Context System: [READY/NOT READY]

EOF

cat /tmp/v16_validation_results.txt
```

---

## Success Criteria

### V1.6 Complete When:
- âœ… All 12 tests pass
- âœ… Context files exist in database
- âœ… Agents demonstrate system knowledge
- âœ… Multi-turn conversations work
- âœ… Performance within targets (<8s, <10k tokens)
- âœ… No critical bugs in production

### V2.0 Ready When:
- âœ… V1.6 stable in production for 7 days
- âœ… User feedback collected
- âœ… Performance metrics baseline established
- âœ… V2.0 architecture design approved
- âœ… Resource requirements estimated

---

## Timeline

| Phase | Duration | Status |
|-------|----------|--------|
| Phase 1: Complete V1.6 | 30 min | â³ In Progress |
| Phase 2: End-to-End Testing | 60 min | â³ Pending |
| Phase 3: V2.0 Planning | 30 min | â³ Pending |
| Phase 4: Validation Report | 10 min | â³ Pending |
| **Total** | **2.5 hours** | |

---

## Next Actions

1. **NOW:** Wait for Railway deployment (check every 2 min)
2. **+5 min:** Run Test A & B (check if context exists)
3. **+10 min:** Create context files if needed
4. **+20 min:** Re-test after context creation
5. **+30 min:** Run full test suite (Tests 1-12)
6. **+90 min:** Write validation report
7. **+120 min:** Plan V2.0 architecture

---

**END OF V1.6 COMPLETION PLAN**
