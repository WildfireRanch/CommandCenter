# V1.6 Testing Plan - Agent Monitoring System

**Version:** V1.5.0 → V1.6.0
**Date:** October 11, 2025
**Purpose:** Ensure V1.6 agent monitoring features are fully compatible with V1.5 production system

---

## 🎯 Testing Objectives

1. **Verify Backward Compatibility** - All V1.5 features still work
2. **Validate New Features** - Agent monitoring works as designed
3. **Ensure Data Integrity** - No corruption of existing data
4. **Confirm Performance** - No significant performance degradation
5. **Check Error Handling** - Telemetry failures don't break agents

---

## 📋 Pre-Deployment Testing Checklist

### Phase 1: Database Migration Testing

#### 1.1 Migration Execution
- [ ] **Run migration via API endpoint**
  ```bash
  curl -X POST https://api.wildfireranch.us/db/init-schema \
    -H "Content-Type: application/json"
  ```
  **Expected:** HTTP 200, message "Database schema initialized successfully"

- [ ] **Verify migration success**
  ```bash
  curl https://api.wildfireranch.us/db/schema-status | jq
  ```
  **Expected:** Response includes `agent_metrics` schema

- [ ] **Check tables created**
  ```bash
  # In Railway PostgreSQL console
  SELECT table_schema, table_name
  FROM information_schema.tables
  WHERE table_schema = 'agent_metrics'
  ORDER BY table_name;
  ```
  **Expected:** 4 tables (agent_events, agent_health_checks, tool_execution_log, agent_performance_metrics)

- [ ] **Check views created**
  ```bash
  # In Railway PostgreSQL console
  SELECT table_name
  FROM information_schema.views
  WHERE table_schema = 'agent_metrics';
  ```
  **Expected:** 2 views (agent_health_summary, recent_agent_activity)

- [ ] **Verify indexes created**
  ```bash
  # In Railway PostgreSQL console
  SELECT indexname
  FROM pg_indexes
  WHERE schemaname = 'agent_metrics';
  ```
  **Expected:** 10+ indexes on key columns

#### 1.2 Data Integrity
- [ ] **Existing tables untouched**
  ```bash
  # Verify row counts didn't change
  SELECT 'agent.conversations' as table, COUNT(*) FROM agent.conversations
  UNION ALL
  SELECT 'agent.messages', COUNT(*) FROM agent.messages
  UNION ALL
  SELECT 'kb_documents', COUNT(*) FROM kb_documents
  UNION ALL
  SELECT 'solark.telemetry', COUNT(*) FROM solark.telemetry;
  ```
  **Expected:** Same counts as before migration

- [ ] **No schema conflicts**
  ```bash
  # Verify no naming conflicts
  SELECT table_schema, table_name
  FROM information_schema.tables
  WHERE table_name IN ('conversations', 'messages', 'telemetry', 'kb_documents')
  ORDER BY table_schema, table_name;
  ```
  **Expected:** Each table appears once in its correct schema

---

### Phase 2: Backend API Testing

#### 2.1 Existing V1.5 Endpoints (Regression Testing)

**Core Endpoints:**
- [ ] `GET /` - API info
  ```bash
  curl https://api.wildfireranch.us/
  ```
  **Expected:** `{"name": "CommandCenter API", "version": "1.0.0", ...}`

- [ ] `GET /health` - System health
  ```bash
  curl https://api.wildfireranch.us/health | jq
  ```
  **Expected:** `{"status": "healthy", "checks": {...}}`

**Energy Endpoints:**
- [ ] `GET /energy/latest` - Latest energy data
  ```bash
  curl https://api.wildfireranch.us/energy/latest | jq
  ```
  **Expected:** Latest telemetry snapshot with SOC, solar power, etc.

- [ ] `GET /energy/stats?hours=24` - Energy statistics
  ```bash
  curl 'https://api.wildfireranch.us/energy/stats?hours=24' | jq
  ```
  **Expected:** Stats with avg/min/max for battery, solar, load

**Agent Endpoints:**
- [ ] `POST /ask` - Agent chat (CRITICAL TEST)
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is my battery level?"}' | jq
  ```
  **Expected:**
  - Response from Solar Controller
  - Session ID returned
  - Duration < 10 seconds
  - **NEW:** Telemetry event logged (check activity endpoint)

- [ ] `GET /conversations` - Conversation history
  ```bash
  curl https://api.wildfireranch.us/conversations | jq
  ```
  **Expected:** List of recent conversations

**Knowledge Base Endpoints:**
- [ ] `GET /kb/stats` - KB statistics
  ```bash
  curl https://api.wildfireranch.us/kb/stats | jq
  ```
  **Expected:** Document count, chunk count, etc.

- [ ] `POST /kb/search` - KB search
  ```bash
  curl -X POST https://api.wildfireranch.us/kb/search \
    -H "Content-Type: application/json" \
    -d '{"query": "minimum battery SOC", "limit": 3}' | jq
  ```
  **Expected:** Relevant document chunks with scores

#### 2.2 New V1.6 Endpoints

**Agent Health:**
- [ ] `GET /agents/health` - All agents status
  ```bash
  curl https://api.wildfireranch.us/agents/health | jq
  ```
  **Expected:**
  ```json
  {
    "status": "success",
    "data": {
      "total_agents": 3,
      "online": 3,
      "degraded": 0,
      "offline": 0,
      "error": 0,
      "overall_status": "healthy",
      "agents": [
        {
          "agent_name": "Manager",
          "status": "online",
          "response_time_ms": 50,
          "checked_at": "2025-10-11T12:00:00Z"
        },
        // ... 2 more agents
      ]
    }
  }
  ```

- [ ] `GET /agents/Manager/health` - Single agent health
  ```bash
  curl https://api.wildfireranch.us/agents/Manager/health | jq
  ```
  **Expected:** Manager agent health details

- [ ] `GET /agents/Solar%20Controller/health` - URL-encoded agent name
  ```bash
  curl 'https://api.wildfireranch.us/agents/Solar%20Controller/health' | jq
  ```
  **Expected:** Solar Controller health details

**Agent Activity:**
- [ ] `GET /agents/activity` - Recent activity (before any queries)
  ```bash
  curl https://api.wildfireranch.us/agents/activity | jq
  ```
  **Expected:** Empty array `{"status": "success", "count": 0, "data": []}`

- [ ] `GET /agents/activity?limit=10` - Limited results
  ```bash
  curl 'https://api.wildfireranch.us/agents/activity?limit=10' | jq
  ```
  **Expected:** Max 10 events

- [ ] `GET /agents/Manager/activity` - Agent-specific activity
  ```bash
  curl https://api.wildfireranch.us/agents/Manager/activity | jq
  ```
  **Expected:** Only Manager events

**Agent Metrics:**
- [ ] `GET /agents/metrics?hours=24` - All agents metrics
  ```bash
  curl 'https://api.wildfireranch.us/agents/metrics?hours=24' | jq
  ```
  **Expected:** Aggregated metrics (may be empty initially)

- [ ] `GET /agents/Solar%20Controller/metrics` - Single agent metrics
  ```bash
  curl 'https://api.wildfireranch.us/agents/Solar%20Controller/metrics' | jq
  ```
  **Expected:** Solar Controller metrics

**System Stats:**
- [ ] `GET /system/stats` - System statistics (NEW)
  ```bash
  curl https://api.wildfireranch.us/system/stats | jq
  ```
  **Expected:**
  ```json
  {
    "status": "success",
    "data": {
      "total_energy_snapshots": 12345,
      "total_conversations": 67,
      "conversations_today": 5,
      "latest_energy": {
        "timestamp": "2025-10-11T12:00:00Z",
        "battery_soc": 52.3,
        "solar_power": 1234
      },
      "agent_events_24h": 0
    }
  }
  ```

---

### Phase 3: Agent Execution Testing (Critical)

#### 3.1 Agent Routing & Execution

**Test 1: Solar Controller (Real-time Query)**
- [ ] **Ask real-time question**
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is my battery level?"}' | jq
  ```
  **Expected:**
  - Response contains battery SOC percentage
  - `agent_used` = "Solar Controller"
  - Duration < 10 seconds
  - No errors in response

- [ ] **Verify telemetry logged**
  ```bash
  curl https://api.wildfireranch.us/agents/activity?limit=5 | jq
  ```
  **Expected:**
  - At least 2 events (start + stop for Solar Controller)
  - Event types: "start", "stop"
  - Status: "success"
  - Duration recorded

**Test 2: Energy Orchestrator (Planning Query)**
- [ ] **Ask planning question**
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "Should we run the miners right now?"}' | jq
  ```
  **Expected:**
  - Response contains recommendation
  - `agent_used` = "Energy Orchestrator"
  - Duration < 20 seconds
  - References current SOC and power levels

- [ ] **Verify telemetry logged**
  ```bash
  curl https://api.wildfireranch.us/agents/activity?limit=5 | jq
  ```
  **Expected:** Energy Orchestrator start/stop events

**Test 3: KB Fast-Path (Documentation Query)**
- [ ] **Ask documentation question**
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is the minimum battery SOC threshold?"}' | jq
  ```
  **Expected:**
  - Response contains policy information
  - `agent_used` = "Knowledge Base" (fast-path)
  - Duration < 2 seconds (fast!)
  - No Manager routing

- [ ] **Verify NO Manager telemetry for fast-path**
  ```bash
  curl https://api.wildfireranch.us/agents/Manager/activity | jq
  ```
  **Expected:** No events for this query (KB fast-path bypasses Manager)

**Test 4: Manager Agent (Routing)**
- [ ] **Ask ambiguous question that requires routing**
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "Tell me about my energy system"}' | jq
  ```
  **Expected:**
  - Manager routes to Solar Controller
  - Response contains current status
  - Manager telemetry logged

#### 3.2 Telemetry Data Validation

- [ ] **Check event completeness**
  ```bash
  curl https://api.wildfireranch.us/agents/activity?limit=50 | jq '.data[] | {agent_name, event_type, event_status, duration_ms}'
  ```
  **Verify:**
  - Each agent execution has start + stop events
  - Stop events have duration_ms
  - No orphaned start events (without matching stop)
  - Status is "success" or "failure" (not "in_progress" for old events)

- [ ] **Check health updates**
  ```bash
  curl https://api.wildfireranch.us/agents/health | jq '.data.agents[] | {agent_name, status, checked_at}'
  ```
  **Verify:**
  - Agents that ran queries show "online"
  - Checked_at timestamp is recent
  - Response_time_ms is reasonable (<100ms for health check)

---

### Phase 4: Frontend Testing

#### 4.1 Existing V1.5 Pages (Regression)

**Dashboard Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/dashboard`
  **Expected:** Page loads, no errors, energy data displays

**Chat Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/chat`
  **Expected:** Chat interface works, can send messages

**Energy Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/energy`
  **Expected:** Energy charts display, real-time data updates

**Status Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/status`
  **Expected:**
  - Page loads
  - Shows API/DB status
  - **NEW:** Shows "Agent Services" section with 3 agent cards

**Logs Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/logs`
  **Expected:** Conversation history displays

**Library Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/kb`
  **Expected:** KB documents list

#### 4.2 New V1.6 Pages

**Agent Monitor Page:**
- [ ] Visit `https://dashboard.wildfireranch.us/agents`
  **Expected:**
  - Page loads without errors
  - Summary stats cards display (4 cards)
  - 3 agent health cards display
  - Tool usage chart renders (may be empty initially)
  - Performance chart renders (may be empty initially)
  - Activity feed displays (may show "No recent activity")

- [ ] **After making agent queries**
  - Refresh `/agents` page
  - **Expected:**
    - Activity feed shows recent queries
    - Agent health cards show "online" status
    - Charts populate with data (if enough data points)

**Navigation:**
- [ ] Check sidebar includes "Agent Monitor" link
  **Expected:** Link visible between "Power Plant" and "Logs"

- [ ] Click "Agent Monitor" link
  **Expected:** Navigates to `/agents` page

#### 4.3 Component Testing

**AgentHealthCard:**
- [ ] Each card shows:
  - Agent name (Manager, Solar Controller, Energy Orchestrator)
  - Status badge with correct color
  - Pulse animation for online agents
  - Last seen timestamp
  - Response time (if available)

**AgentActivityFeed:**
- [ ] Feed displays recent events
- [ ] Auto-refreshes (watch for 5-10 seconds)
- [ ] Events show:
  - Timestamp
  - Agent name
  - Event description
  - Duration (if applicable)
  - Color coding by status

**Enhanced Status Page:**
- [ ] "Agent Services" section shows 3 cards
- [ ] Each card shows status icon (green check or red X)
- [ ] Response times displayed

---

### Phase 5: Performance Testing

#### 5.1 Response Time Comparison (Before vs After)

**Baseline (V1.5):**
Record baseline response times before deployment:
- [ ] Solar Controller query: _____ ms
- [ ] Energy Orchestrator query: _____ ms
- [ ] KB search: _____ ms

**After V1.6 Deployment:**
- [ ] Solar Controller query: _____ ms (should be within 10% of baseline)
- [ ] Energy Orchestrator query: _____ ms (should be within 10% of baseline)
- [ ] KB search: _____ ms (should be within 10% of baseline)

**Acceptable:**
- Increase of <10% per query (telemetry adds ~10-50ms overhead)
- Total degradation < 100ms for any query

**Red Flag:**
- Increase of >20% per query
- Timeouts or >30s responses

#### 5.2 Database Performance

- [ ] **Check query performance**
  ```sql
  -- In Railway PostgreSQL console
  SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
  FROM pg_stat_statements
  WHERE query LIKE '%agent_metrics%'
  ORDER BY mean_exec_time DESC
  LIMIT 10;
  ```
  **Expected:** Mean execution time < 50ms for telemetry inserts

- [ ] **Check database size growth**
  ```sql
  SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
  FROM pg_tables
  WHERE schemaname IN ('agent', 'agent_metrics', 'solark', 'public')
  ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
  ```
  **Expected:** agent_metrics tables are small (<10MB initially)

#### 5.3 Telemetry Overhead

- [ ] **Run 10 sequential queries, measure total time**
  ```bash
  time for i in {1..10}; do
    curl -X POST https://api.wildfireranch.us/ask \
      -H "Content-Type: application/json" \
      -d '{"message": "What is my battery level?"}' \
      --silent > /dev/null
  done
  ```
  **Expected:** Total time ~60-100 seconds (6-10s per query)

---

### Phase 6: Error Handling & Edge Cases

#### 6.1 Telemetry Failure Scenarios

**Test 1: Database Unavailable (Simulated)**
- [ ] **Temporarily break database connection**
  - Set DATABASE_URL to invalid value in Railway
  - Redeploy
  - Try agent query
  **Expected:**
  - Agent query still returns response (degraded, but not broken)
  - Error logged in Railway logs
  - Telemetry fails gracefully

**Test 2: Missing Agent Name**
- [ ] `curl https://api.wildfireranch.us/agents//health`
  **Expected:** 404 or 400 error

**Test 3: Invalid Agent Name**
- [ ] `curl https://api.wildfireranch.us/agents/FakeAgent/health`
  **Expected:** Error or "No health data for FakeAgent"

#### 6.2 Data Validation

**Test: Query with Special Characters**
- [ ] Send query with SQL injection attempt
  ```bash
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is my battery level?'"'"'; DROP TABLE agent_metrics.agent_events;--"}' | jq
  ```
  **Expected:**
  - Agent responds normally
  - Tables NOT dropped (parameterized queries protect)
  - Query logged safely in telemetry

**Test: Very Long Query**
- [ ] Send 10,000 character query
  **Expected:**
  - Agent processes or truncates
  - Telemetry logs (may truncate query text)
  - No crashes

---

### Phase 7: Integration Testing

#### 7.1 End-to-End User Flow

**Scenario: New User Arrives**
1. [ ] Visit `https://dashboard.wildfireranch.us/`
2. [ ] Click "Agent Monitor" in sidebar
3. [ ] Observe agent health (likely "degraded" before first use)
4. [ ] Navigate to "Ask Agent"
5. [ ] Ask: "What's my battery level?"
6. [ ] Wait for response
7. [ ] Return to "Agent Monitor"
8. [ ] **Expected:**
   - Activity feed shows the query
   - Agent status changed to "online"
   - Charts update (if enough data)

**Scenario: Multiple Agent Queries**
1. [ ] Ask Solar Controller question
2. [ ] Ask Energy Orchestrator question
3. [ ] Ask KB question
4. [ ] Check `/agents/activity`
5. [ ] **Expected:**
   - All 3 queries appear in feed
   - Different agent names displayed
   - Correct event types

#### 7.2 Multi-Turn Conversation

- [ ] Start conversation with session_id
  ```bash
  # First query
  RESPONSE=$(curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d '{"message": "What is my battery level?"}')

  SESSION_ID=$(echo $RESPONSE | jq -r '.session_id')

  # Second query in same conversation
  curl -X POST https://api.wildfireranch.us/ask \
    -H "Content-Type: application/json" \
    -d "{\"message\": \"What about solar production?\", \"session_id\": \"$SESSION_ID\"}" | jq
  ```
  **Expected:**
  - Both queries share same session_id
  - Both appear in activity feed
  - Both linked to same conversation

---

## 🚨 Critical Failure Scenarios

If ANY of these occur, **DO NOT DEPLOY** or **ROLLBACK IMMEDIATELY**:

1. **Existing endpoint returns 500 error** (V1.5 regression)
2. **Agent queries hang or timeout** (>30s with no response)
3. **Database migration fails with errors** (not skipped files)
4. **Existing data corrupted or deleted** (conversations, energy data, KB)
5. **Frontend pages crash with errors** (dashboard, chat, energy)

---

## ✅ Success Criteria

### Minimum Requirements for Deployment:
- [ ] All Phase 1 tests pass (Database Migration)
- [ ] All Phase 2.1 tests pass (V1.5 Endpoint Regression)
- [ ] All Phase 3.1 tests pass (Agent Execution)
- [ ] At least 1 telemetry event logged per agent type
- [ ] Frontend pages load without errors
- [ ] Performance degradation < 10%

### Full V1.6 Feature Validation:
- [ ] All 7 new API endpoints return data
- [ ] Agent health tracking works
- [ ] Activity feed populates
- [ ] Charts render (even if empty initially)
- [ ] No errors in Railway logs related to telemetry

---

## 📝 Test Execution Tracking

**Date Executed:** _____________
**Executed By:** _____________
**Environment:** Production / Staging
**V1.5 Baseline Performance:** Recorded ☐ / Not Needed ☐

### Phase Results:
- Phase 1 (Database): ☐ Pass ☐ Fail - Notes: __________
- Phase 2 (API): ☐ Pass ☐ Fail - Notes: __________
- Phase 3 (Agents): ☐ Pass ☐ Fail - Notes: __________
- Phase 4 (Frontend): ☐ Pass ☐ Fail - Notes: __________
- Phase 5 (Performance): ☐ Pass ☐ Fail - Notes: __________
- Phase 6 (Errors): ☐ Pass ☐ Fail - Notes: __________
- Phase 7 (Integration): ☐ Pass ☐ Fail - Notes: __________

**Overall Result:** ☐ APPROVED FOR PRODUCTION ☐ NEEDS FIXES

**Blocker Issues:** _____________________________

**Non-Blocker Issues:** _________________________

**Deployment Decision:** ☐ Deploy ☐ Hold ☐ Rollback

---

## 🔧 Rollback Plan

If critical failures occur:

1. **Immediate:** Revert Railway deployment to previous version
2. **Database:** Agent_metrics schema is isolated - can be dropped without affecting V1.5
3. **Frontend:** Revert Vercel deployment (automatic via git)
4. **Verification:** Run Phase 2.1 tests to confirm V1.5 functionality restored

**Rollback Command:**
```bash
# In Railway PostgreSQL console (if needed)
DROP SCHEMA IF EXISTS agent_metrics CASCADE;
```

---

**Testing Plan Version:** 1.0
**Compatible With:** V1.5.0 → V1.6.0
**Last Updated:** October 11, 2025
