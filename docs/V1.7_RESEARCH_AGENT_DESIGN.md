# V1.7 Research Agent Design

**Feature**: Generalist Research Agent with Web Search via Tavily MCP
**Target Release**: V1.7 (2-3 weeks after V1.6 stabilizes)
**Status**: Design Phase

---

## üéØ Problem Statement

Current agents are **lightweight specialists**:
- Solar Controller: Monitors hardware, answers status queries
- Energy Orchestrator: Plans operations, optimizes usage

**Gap**: No agent can handle:
- Abstract/conceptual questions
- Industry research and comparisons
- "How does my system compare to..."
- "What are best practices for..."
- Questions requiring current web information

**Need**: Generalist Research Agent with broad context + web search

---

## üèóÔ∏è Architecture

### Agent Hierarchy

```
Manager (Router)
‚îú‚îÄ‚Üí Solar Controller (Specialist) - 5s, narrow context
‚îú‚îÄ‚Üí Energy Orchestrator (Specialist) - 13s, narrow context
‚îú‚îÄ‚Üí Research Agent (Generalist) - 20-30s, FULL context + web ‚≠ê NEW
‚îî‚îÄ‚Üí KB Fast-Path - 400ms, no agent
```

### Research Agent Characteristics

**Context**: Full 24KB (all 4 context files)
**Tools**:
- Local: KB search (deep), historical stats, system efficiency
- Remote: Tavily MCP (web search, extract, map, crawl)

**Response Time**: 20-30 seconds (acceptable for research queries)

**Use Cases**:
- "What are industry best practices for off-grid solar?"
- "Should I upgrade to bifacial panels?"
- "How does my energy cost compare to grid-tied?"
- "What's the latest on LiFePO4 battery technology?"
- "Compare my system specs to typical residential solar"

---

## üåê Tavily MCP Integration

### Why MCP Instead of Direct API?

**Direct API Approach**:
```python
from tavily import TavilyClient
client = TavilyClient(api_key="...")  # Tight coupling
```

**MCP Approach**:
```python
# Agent calls generic "web_search" tool
# MCP client routes to Tavily server
# Loose coupling, swappable providers
```

**Benefits**:
1. Same MCP server used by Claude Desktop (reusable)
2. Can swap providers without agent code changes
3. Better separation of concerns
4. Easier testing and monitoring

### Tavily MCP Options

**Option A: Remote MCP Server (Recommended)**
```
Research Agent ‚Üí HTTP MCP Client ‚Üí https://mcp.tavily.com/mcp/?tavilyApiKey=XXX
```
- Hosted by Tavily
- Zero infrastructure
- Just need API key
- Production-ready

**Option B: Local MCP Server**
```
Research Agent ‚Üí stdio MCP Client ‚Üí Local tavily-mcp process (npx)
```
- More control
- Can customize
- Runs on Railway

### Available Tools

From `tavily-mcp` package:

1. **`tavily-search`**
   - Web search with AI summarization
   - Returns: Title, URL, content snippet, relevance score
   - Use: General research queries

2. **`tavily-extract`**
   - Extract full content from URLs
   - Returns: Structured article content
   - Use: Deep-dive on specific sources

3. **`tavily-map`**
   - Map website structure
   - Returns: Site hierarchy
   - Use: Understanding documentation sites

4. **`tavily-crawl`**
   - Crawl multiple pages
   - Returns: Aggregated content
   - Use: Comprehensive research on topic

---

## üîß Technical Implementation

### File Structure

```
railway/src/agents/
  ‚îú‚îÄ‚îÄ manager.py (updated routing)
  ‚îú‚îÄ‚îÄ solar_controller.py (existing)
  ‚îú‚îÄ‚îÄ energy_orchestrator.py (existing)
  ‚îî‚îÄ‚îÄ research_agent.py ‚≠ê NEW

railway/src/tools/
  ‚îú‚îÄ‚îÄ kb_search.py (existing)
  ‚îú‚îÄ‚îÄ energy_monitor.py (existing)
  ‚îî‚îÄ‚îÄ mcp_client.py ‚≠ê NEW (wrapper for MCP calls)

railway/src/integrations/
  ‚îî‚îÄ‚îÄ tavily_mcp.py ‚≠ê NEW (Tavily MCP client)
```

### Dependencies

Add to `railway/requirements.txt`:
```txt
mcp>=0.5.0                    # MCP SDK for Python
httpx>=0.24.0                 # For HTTP MCP client (if using remote)
```

### Environment Variables

Add to Railway:
```env
TAVILY_API_KEY=tvly-xxxxx     # Get from app.tavily.com
TAVILY_MCP_URL=https://mcp.tavily.com/mcp  # Optional, for remote server
```

---

## üìù Research Agent Implementation

### Agent Definition

```python
# railway/src/agents/research_agent.py

from crewai import Agent, Task
from ..tools.kb_search import get_context_files, search_knowledge_base
from ..tools.mcp_client import tavily_search, tavily_extract

def create_research_agent() -> Agent:
    """
    Create the Research Agent with full context + web search.

    For: Abstract questions, industry research, comparisons, planning
    """
    # Load ALL context (24KB)
    full_context = get_context_files()

    backstory = f"""You are a senior energy systems consultant with deep
    expertise in off-grid solar installations, battery storage, and
    sustainable energy systems.

    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    COMPLETE SYSTEM CONTEXT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    {full_context}

    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    Your capabilities:

    1. SYSTEM KNOWLEDGE (from context above)
       - Complete hardware specifications
       - All operational policies and thresholds
       - User preferences and priorities
       - System history and performance

    2. KNOWLEDGE BASE ACCESS
       - Detailed technical documentation
       - Operating procedures and manuals
       - Historical learnings and best practices

    3. WEB SEARCH (Tavily MCP)
       - Current industry information
       - Recent technology developments
       - Expert opinions and case studies
       - Vendor comparisons and reviews

    TOOL USAGE GUIDELINES:

    - Use SYSTEM CONTEXT (above) for specific system facts
    - Use KNOWLEDGE BASE for detailed procedures/manuals
    - Use WEB SEARCH for:
      * Current industry trends and news
      * Technology comparisons and reviews
      * Best practices not in KB
      * Expert opinions and case studies
      * "What's the latest on..." queries

    Your role is to provide:
    - Research-backed recommendations
    - Industry comparisons and benchmarks
    - Long-term strategic planning
    - Technology trend analysis
    - Abstract problem solving

    Always cite sources when using web search or KB.
    Combine multiple information sources for comprehensive answers.
    """

    return Agent(
        role="Energy Systems Research Consultant",
        goal="Provide research-backed insights and strategic recommendations",
        backstory=backstory,
        tools=[
            search_knowledge_base,      # Local KB
            tavily_search,              # Web search via MCP
            tavily_extract,             # Deep article extraction via MCP
        ],
        verbose=True,
        allow_delegation=False,
    )
```

### Manager Routing Update

```python
# railway/src/agents/manager.py

@tool("Route to Research Agent")
def route_to_research_agent(query: str) -> str:
    """
    Route to Research Agent for abstract, research, or comparative queries.

    Use when query involves:
    - Industry best practices or trends
    - Technology comparisons ("X vs Y")
    - "How does my system compare..."
    - "What should I consider for..."
    - "Is it worth upgrading to..."
    - "What are experts saying about..."
    - Future planning and strategy
    - Abstract/conceptual questions
    - Questions requiring current web information

    Examples:
    - "What are the latest trends in solar storage?"
    - "Should I upgrade to bifacial panels?"
    - "How does my energy cost compare to grid-tied?"
    - "What do experts say about LiFePO4 longevity?"
    - "Compare SolArk vs Victron inverters"
    """
    import json
    return json.dumps({
        "action": "route",
        "agent": "Research Agent",
        "agent_role": "Energy Systems Research Consultant",
        "query": str(query)
    })

# Update Manager tools list
def create_manager_agent() -> Agent:
    return Agent(
        role="Query Router and Coordinator",
        # ... existing config ...
        tools=[
            route_to_solar_controller,
            route_to_energy_orchestrator,
            route_to_research_agent,  # ‚≠ê NEW
            search_kb_directly
        ]
    )
```

---

## üß™ Testing Strategy

### Test Cases

**1. Industry Research**
```
Query: "What are current best practices for off-grid solar battery sizing?"
Expected: Web search + system context comparison
```

**2. Technology Comparison**
```
Query: "Should I upgrade from LiFePO4 to solid-state batteries?"
Expected: Web research on solid-state + cost/benefit analysis
```

**3. System Benchmarking**
```
Query: "How does my 14.6kW solar system compare to typical residential?"
Expected: System context + industry averages from web
```

**4. Future Planning**
```
Query: "Is it worth adding more solar panels given current technology trends?"
Expected: Trend analysis + ROI calculation with system data
```

### Validation Criteria

- ‚úÖ Routes correctly from Manager
- ‚úÖ Uses system context for specific facts
- ‚úÖ Searches web for current information
- ‚úÖ Cites all sources (system, KB, web)
- ‚úÖ Provides actionable recommendations
- ‚úÖ Response time < 30 seconds

---

## üí∞ Cost Analysis

### Tavily Pricing
- **Free Tier**: 1,000 searches/month
- **Basic**: $20/month for 10,000 searches
- **Pro**: $100/month for 100,000 searches

### Estimated Usage
- Research queries: ~10-20 per day
- Monthly: ~300-600 queries
- **Cost**: Free tier sufficient initially

### Comparison to Alternatives
- Perplexity: $20/month (no free tier)
- SerpAPI: $50/month (Google search)
- Brave Search: $5/month (limited results)

**Tavily wins**: Free tier + MCP support + AI-optimized results

---

## üìÖ Implementation Timeline

### Phase 1: Core Infrastructure (2-3 hours)
- [ ] Add MCP client library
- [ ] Create `mcp_client.py` wrapper
- [ ] Test Tavily MCP connection (remote server)

### Phase 2: Research Agent (2-3 hours)
- [ ] Implement `research_agent.py`
- [ ] Add full context loading
- [ ] Add web search tools

### Phase 3: Manager Integration (1-2 hours)
- [ ] Add `route_to_research_agent` tool
- [ ] Update routing logic
- [ ] Update Manager backstory

### Phase 4: Testing & Validation (2-3 hours)
- [ ] Test all 4 routing scenarios
- [ ] Validate web search results
- [ ] Performance benchmarking
- [ ] Cost monitoring

### Phase 5: Documentation (1 hour)
- [ ] Update V1.7 release notes
- [ ] Add usage examples
- [ ] Update PROJECT_STATUS.md

**Total Estimate**: 8-12 hours (1-2 days of focused work)

---

## üöÄ Deployment Strategy

### V1.7.0-beta (Test in Production)
1. Deploy Research Agent (routing disabled)
2. Test via direct API calls
3. Validate web search integration
4. Monitor costs and performance

### V1.7.0 (Public Release)
1. Enable routing from Manager
2. Announce in dashboard
3. Monitor usage patterns
4. Gather feedback

### V1.7.1+ (Refinement)
- Optimize web search queries
- Fine-tune routing logic
- Add more research tools (map, crawl)

---

## üîí Security & Privacy

### API Key Management
- Store `TAVILY_API_KEY` in Railway environment variables
- Never expose in logs or responses
- Use Railway's built-in secrets management

### Data Privacy
- Web searches go through Tavily (trusted provider)
- No system data sent to web (only generic queries)
- All PII stays in Railway database

### Rate Limiting
- Tavily free tier: 1,000 searches/month
- Implement query caching to reduce duplicates
- Monitor usage via Tavily dashboard

---

## üìä Success Metrics

### Usage Metrics
- % of queries routed to Research Agent
- Average response time
- Web search queries per day
- User satisfaction (implicit: repeat usage)

### Quality Metrics
- Source citation rate (should be 100%)
- Actionable recommendations (manual review)
- Response accuracy (user feedback)

### Cost Metrics
- Tavily API calls per day
- Cost per research query
- Stay within free tier initially

---

## üîÆ Future Enhancements (V1.8+)

### Additional Tools
- **`tavily-map`**: Map vendor websites for product comparisons
- **`tavily-crawl`**: Deep research on specific topics
- **PDF Analysis**: Extract data from technical papers

### Advanced Features
- **Research Caching**: Cache web results for common queries
- **Trend Analysis**: Track industry trends over time
- **Competitive Analysis**: Compare system to industry benchmarks
- **ROI Calculator**: Financial modeling with current prices

### Integration Opportunities
- **Email Summaries**: Weekly industry news digest
- **Alert System**: Notify on relevant tech developments
- **Knowledge Base Growth**: Auto-add relevant articles to KB

---

## ‚úÖ Decision Log

**2025-10-11**: Use Tavily MCP (remote server) instead of direct API
- Reason: Better separation of concerns, reusable MCP infrastructure
- Trade-off: Extra network hop, but worth it for architecture

**2025-10-11**: Research Agent gets FULL 24KB context
- Reason: Needs comprehensive understanding for comparisons
- Trade-off: Higher token costs, but necessary for quality

**2025-10-11**: Deploy as V1.7 after V1.6 stabilizes
- Reason: Don't rush, let V1.6 prove stable first
- Timeline: 2-3 weeks from V1.6 release

---

## üìö References

- [Tavily MCP GitHub](https://github.com/tavily-ai/tavily-mcp)
- [Tavily API Docs](https://docs.tavily.com)
- [MCP Protocol Spec](https://modelcontextprotocol.io)
- [CrewAI Documentation](https://docs.crewai.com)

---

*Last Updated: 2025-10-11*
*Status: Design Phase - Ready for Implementation*
